package com.mpcz.deposit_scheme.backend.api.controller;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.mpcz.deposit_scheme.backend.api.domain.User;
import com.mpcz.deposit_scheme.backend.api.dto.ConsumerApplicationDetailsFilterDTO;
import com.mpcz.deposit_scheme.backend.api.repository.ConsumerApplictionDetailRepository;
import com.mpcz.deposit_scheme.backend.api.repository.EstimateAmountRepository;
import com.mpcz.deposit_scheme.backend.api.response.Response;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerApplicationDetailService;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerService;
import com.mpcz.deposit_scheme.backend.api.services.UserService;

@RestController
@CrossOrigin(origins = "*", maxAge = 3600)
@RequestMapping("/api/user/pagination")
public class PaginationController {

    @Autowired
    private ConsumerApplictionDetailRepository consumerApplicationDetailRepository;

    @Autowired
    private ConsumerApplicationDetailService consumerApplicationDetailService;

    @Autowired
    private UserService userService;

   

    @Autowired
    private ConsumerService consumerService;

    @Autowired
    private EstimateAmountRepository estimateAmountRepository;

    @GetMapping("/getAllApplicationByStatusCount")
    public Response getAllDataFromView() {
        Response response = new Response();
        System.err.println("Before entering database: " + LocalDateTime.now());

        ConsumerApplicationDetailsFilterDTO filterDTO = checkUser();
        List<Map<String, Object>> allDataCount = consumerApplicationDetailRepository
                .getAllDataCount1(filterDTO.getDiscomId(), filterDTO.getRegionId(), filterDTO.getCircleId(),
                        filterDTO.getDivisionId(), filterDTO.getSubDivisionId(), filterDTO.getDcId());

        System.err.println("After fetching data from database: " + LocalDateTime.now());

        if (allDataCount.isEmpty()) {
            response.setCode("404");
            response.setMessage("Data not found");
        } else {
            response.setCode("200");
            response.setMessage("Data found successfully");
            response.setList(allDataCount);
        }
        return response;
    }

    public ConsumerApplicationDetailsFilterDTO checkUser() {
        String userLoginId = SecurityContextHolder.getContext().getAuthentication().getName();
        ConsumerApplicationDetailsFilterDTO filterDTO = new ConsumerApplicationDetailsFilterDTO();
        filterDTO.setUserLoginId(userLoginId);

        if (userLoginId != null) {
            User user = userService.findByUserId(userLoginId);
            String accessLevel = user.getAccessLevel();

            

            switch (accessLevel) {
                case "1":
                    // Discom level
                	filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
                    break;
                case "2":
                    // Region level
                    if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
                        filterDTO.setRegionId(user.getUserRegion().getRegionId());
                    }
                    break;
                case "3":
                    // Circle level
                    if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
                        filterDTO.setRegionId(user.getUserRegion().getRegionId());
                    }
                    if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
                        filterDTO.setCircleId(user.getUserCircle().getCircleId());
                    }
                    break;
                case "4":
                    // Division level
                    if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
                        filterDTO.setRegionId(user.getUserRegion().getRegionId());
                    }
                    if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
                        filterDTO.setCircleId(user.getUserCircle().getCircleId());
                    }
                    if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
                        filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
                    }
                    break;
                case "5":
                    // Subdivision level
                    if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
                        filterDTO.setRegionId(user.getUserRegion().getRegionId());
                    }
                    if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
                        filterDTO.setCircleId(user.getUserCircle().getCircleId());
                    }
                    if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
                        filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
                    }
                    filterDTO.setSubDivisionId(user.getUserSubDivision().getSubDivisionId());
                    break;
                case "6":
                    // DC level
                    if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
                        filterDTO.setRegionId(user.getUserRegion().getRegionId());
                    }
                    if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
                        filterDTO.setCircleId(user.getUserCircle().getCircleId());
                    }
                    if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
                        filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
                    }
                    filterDTO.setSubDivisionId(user.getUserSubDivision().getSubDivisionId());
                    filterDTO.setDcId(user.getUserDc().getDcId());
                    break;
            }
        }
        return filterDTO;
    }

    @GetMapping("/getApplicationData/{applicationStatusId}")
    public Response getAllApplicationByApplicationStatus(@PathVariable String applicationStatusId) {
        Response response = new Response();
        List<String> statusIdList = Arrays.asList(applicationStatusId.split(","));
        System.err.println("Before entering database: " + LocalDateTime.now());

        ConsumerApplicationDetailsFilterDTO filterDTO = checkUser();
        List<Map<String, Object>> allApplicationByApplicationStatus = consumerApplicationDetailRepository
                .getAllApplicationByApplicationStatus1(statusIdList, filterDTO.getDiscomId(), filterDTO.getRegionId(),
                        filterDTO.getCircleId(), filterDTO.getDivisionId(), filterDTO.getSubDivisionId(), filterDTO.getDcId());

        System.err.println("After fetching data from database: " + LocalDateTime.now());

        if (allApplicationByApplicationStatus.isEmpty()) {
            response.setCode("404");
            response.setMessage("Data not found");
        } else {
            response.setCode("200");
            response.setMessage("Data found successfully");
            response.setList(allApplicationByApplicationStatus);
        }
        return response;
    }
}
