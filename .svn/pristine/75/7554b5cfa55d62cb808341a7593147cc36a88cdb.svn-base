package com.mpcz.deposit_scheme.backend.api.controller;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;

import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.mpcz.deposit_scheme.backend.api.constant.HttpCode;
import com.mpcz.deposit_scheme.backend.api.constant.ResponseMessage;
import com.mpcz.deposit_scheme.backend.api.constant.RestApiUrl;
import com.mpcz.deposit_scheme.backend.api.domain.Consumer;
import com.mpcz.deposit_scheme.backend.api.domain.ConsumerApplicationDetail;
import com.mpcz.deposit_scheme.backend.api.domain.User;
import com.mpcz.deposit_scheme.backend.api.dto.ConsumerApplicationDetailsFilterDTO;
import com.mpcz.deposit_scheme.backend.api.exception.ConsumerApplicationDetailException;
import com.mpcz.deposit_scheme.backend.api.exception.FormValidationException;
import com.mpcz.deposit_scheme.backend.api.exception.InvalidAuthenticationException;
import com.mpcz.deposit_scheme.backend.api.exception.PaymentTypeException;
import com.mpcz.deposit_scheme.backend.api.repository.BillPaymentResponseeeeeeeRepository;
import com.mpcz.deposit_scheme.backend.api.repository.ConsumerApplictionDetailRepository;
import com.mpcz.deposit_scheme.backend.api.repository.EstimateAmountRepository;
import com.mpcz.deposit_scheme.backend.api.response.PageConsumerApplicationDetailDTO;
import com.mpcz.deposit_scheme.backend.api.response.Response;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerApplicationDetailService;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerService;
import com.mpcz.deposit_scheme.backend.api.services.UserService;

/**
 * Author: Monika Rajpoot Date : 3-September-2024
 */

@RestController
@CrossOrigin(origins = "*", maxAge = 3600)
@RequestMapping("/api/user/pagination")
public class PaginationController {

	@Autowired
	private ConsumerApplictionDetailRepository consumerApplictionDetailRepository;
	@Autowired
	ConsumerApplicationDetailService consumerApplicationDetailService;

	@Autowired
	private UserService userService;

	@Autowired
	BillPaymentResponseeeeeeeRepository billPaymentResponseeeeeeeRepository;

	@Autowired
	ConsumerService consumerService;

	@Autowired
	EstimateAmountRepository estimateAmountRepository;

//	@GetMapping("/getAllUserWiseConsumerApplicationPagination1")
//	public ResponseEntity<?> getAllUserWiseConsumerApplicationPagination1(HttpServletResponse httpServletResponse)
//			throws FormValidationException, InvalidAuthenticationException, ConsumerApplicationDetailException,
//			PaymentTypeException {
//
//		Response response = new Response();
//		System.err.println("Before Entering database : " + LocalDateTime.now());
//		List<ConsumerApplicationDetail> byConsumerApplicationDetailsByApplicationStatusPaginate1 = null;
//		try {
//			byConsumerApplicationDetailsByApplicationStatusPaginate1 = consumerApplictionDetailRepository
//					.findByConsumerApplicationDetailsByApplicationStatusPaginate2();
//		} catch (Exception e) {
//			e.printStackTrace();
//		}
//
//		System.err.println("After getting data from  database : " + LocalDateTime.now());
////		response.setList(byConsumerApplicationDetailsByApplicationStatusPaginate1);
//		response.setCode("200");
//		response.setMessage("All record retrieved successfully");
//		return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON)
//				.body(byConsumerApplicationDetailsByApplicationStatusPaginate1);
//
//	}

//	public Response<PageConsumerApplicationDetailDTO> findAllConsumerApplicationDetailByApplicationStatusPagination()
//			throws ConsumerApplicationDetailException {
//
//		System.out.println("findAllConsumerApplicationDetailByApplicationStatusPagination method is calling !!!");
//
//		Response<PageConsumerApplicationDetailDTO> response = new Response<PageConsumerApplicationDetailDTO>();
//		PageConsumerApplicationDetailDTO pageConsumerApplicationDetailDTO = new PageConsumerApplicationDetailDTO();
//		
//		List<ConsumerApplicationDetail> byConsumerApplicationDetailsByApplicationStatusPaginate1 = consumerApplictionDetailRepository.findByConsumerApplicationDetailsByApplicationStatusPaginate1();
//		pageConsumerApplicationDetailDTO.setList(byConsumerApplicationDetailsByApplicationStatusPaginate1);
//		response.setList(Arrays.asList(pageConsumerApplicationDetailDTO));
//		response.setCode("200");
//		response.setMessage("All record retrieved successfully");
//		return response;
//	}
//	

//	@GetMapping("/getAllUserWiseConsumerApplicationPagination1")
//	public ResponseEntity<Response<?>> getAllUserWiseConsumerApplicationPagination1(
//			HttpServletResponse httpServletResponse) throws FormValidationException, InvalidAuthenticationException,
//			ConsumerApplicationDetailException, PaymentTypeException {
//
//		System.out.println("getAllUserWiseConsumerApplicationPagination !!!!!");
//
//		final String method = RestApiUrl.USER_APPLICATION_DETAIL_API + RestApiUrl.GET_ALL_PAGINATE_URL
//				+ " : getAllUserWiseConsumerApplicationPagination()";
////		LOG.info(method);
////		List<ConsumerApplicationDetail> all = consumerApplictionDetailRepository.findApplication();
//		Response<PageConsumerApplicationDetailDTO> response = new Response<>();
//
//		String userLoginId = SecurityContextHolder.getContext().getAuthentication().getName();
//
//		ConsumerApplicationDetailsFilterDTO filterDTO = new ConsumerApplicationDetailsFilterDTO();
//
//		filterDTO.setUserLoginId(userLoginId);
//
//		response = findAllConsumerApplicationDetailByApplicationStatusPagination(filterDTO);
//
//		return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);
//
//	}
//
//	public Response<PageConsumerApplicationDetailDTO> findAllConsumerApplicationDetailByApplicationStatusPagination(
//			ConsumerApplicationDetailsFilterDTO filterDTO) throws ConsumerApplicationDetailException {
//
//		System.out.println("findAllConsumerApplicationDetailByApplicationStatusPagination method is calling !!!");
//
////		Response<PageConsumerApplicationDetailDTO> response = new Response<PageConsumerApplicationDetailDTO>();
////		PageConsumerApplicationDetailDTO pageConsumerApplicationDetailDTO = new PageConsumerApplicationDetailDTO();
//		List<ConsumerApplicationDetail> consumerApplicationDetails = findConsumerApplicationDetailByApplicationStatusPaginate(
//				filterDTO);
//		Map<String, Object> pageData = new HashMap<>();
////		Meta meta = new Meta();
////		meta.setCurrentPage(consumerApplicationDetails.getNumber());
////		meta.setTotalItems(consumerApplicationDetails.getTotalElements());
////		meta.setTotalPages(consumerApplicationDetails.getTotalPages());
////		pageConsumerApplicationDetailDTO.setMeta(meta);
////		List<ConsumerApplicationDetail> consumerApplicationDetailList = consumerApplicationDetails.getContent();
////		List<ConsumerApplicationDetail> consumerApplicationDetailList = consumerApplicationDetails;
//		System.err.println("converting pages to billdeskPayment start : " + LocalDateTime.now());
////		for (ConsumerApplicationDetail cad : consumerApplicationDetails) {
////			List<Map<String, String>> transactionDateByConsumerApplicationNo = billPaymentResponseeeeeeeRepository
////					.getTransactionDateByConsumerApplicationNo(cad.getConsumerApplicationNo());
////			System.out.println("transactionDateByConsumerApplicationNo = " + transactionDateByConsumerApplicationNo);
////			cad.setListOfTransactionDate(transactionDateByConsumerApplicationNo);
////		}
//		System.err.println("converting pages to billdeskPayment end : " + LocalDateTime.now());
//		Response response = new Response();
////		pageConsumerApplicationDetailDTO.setList(consumerApplicationDetails);
//		response.setList(consumerApplicationDetails);
//		response.setCode("200");
//		response.setMessage("All record retrieved successfully");
//		return response;
//	}
//
//	public List<ConsumerApplicationDetail> findConsumerApplicationDetailByApplicationStatusPaginate(
//			ConsumerApplicationDetailsFilterDTO filterDTO) throws ConsumerApplicationDetailException {
//
//		System.out.println("findConsumerApplicationDetailPaginate method is calling !!!");
//
//		Response<ConsumerApplicationDetail> response = new Response<>();
////		Pageable paging = PageRequest.of(page, size);
//		List<ConsumerApplicationDetail> pages = null;
//		Integer totalRecords = 0;
//
//		if (filterDTO.getUserLoginId() != null) {
//
//			User user = userService.findByUserId(filterDTO.getUserLoginId());
//
//			switch (user.getAccessLevel()) {
//			case "1":
//				// discomId
//				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
//
//				break;
//			case "2":
//
//				// regionId
//				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
//
//				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
//					filterDTO.setRegionId(user.getUserRegion().getRegionId());
//				}
//
//				break;
//			case "3":
//				// circleId
//				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
//				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
//					filterDTO.setRegionId(user.getUserRegion().getRegionId());
//				}
//				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
//					filterDTO.setCircleId(user.getUserCircle().getCircleId());
//				}
//
//				break;
//			case "4":
//				// divisionId
//				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
//				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
//					filterDTO.setRegionId(user.getUserRegion().getRegionId());
//				}
//				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
//					filterDTO.setCircleId(user.getUserCircle().getCircleId());
//				}
//				if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
//					filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
//				}
//
//				break;
//			case "5":
//				// subDivisionId
//				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
//				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
//					filterDTO.setRegionId(user.getUserRegion().getRegionId());
//				}
//				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
//					filterDTO.setCircleId(user.getUserCircle().getCircleId());
//				}
//				if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
//					filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
//				}
//				filterDTO.setSubDivisionId(user.getUserSubDivision().getSubDivisionId());
//
//				break;
//			case "6":
//				// dcId
//				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
//				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
//					filterDTO.setRegionId(user.getUserRegion().getRegionId());
//				}
//				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
//					filterDTO.setCircleId(user.getUserCircle().getCircleId());
//				}
//				if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
//					filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
//				}
//				filterDTO.setSubDivisionId(user.getUserSubDivision().getSubDivisionId());
//				filterDTO.setDcId(user.getUserDc().getDcId());
//
//				break;
//
//			default:
//				break;
//			}
//
//		}
//
//		if (filterDTO.getConsumerLoginId() != null) {
//
//			Consumer consumer = consumerService.findByConsumerLoginId(filterDTO.getConsumerLoginId());
//
//			filterDTO.setConsumerId(consumer.getConsumerId());
//		}
//
//		System.err.println("before entering database : " + LocalDateTime.now());
//		pages = consumerApplictionDetailRepository.findByConsumerApplicationDetailsByApplicationStatusPaginate1();
//
//		System.err.println("after getting back from database : " + LocalDateTime.now());
////		List<ConsumerApplicationDetail> list = pages.get().collect(Collectors.toList());
//		System.err.println("converting pages to erp workflow start : " + LocalDateTime.now());
////		for (ConsumerApplicationDetail consumerApplicationDetail : pages) {
////			if (consumerApplicationDetail.getErpWorkFlowNumber() != null) {
////				consumerApplicationDetail.setErpWorkFlowSacntion(
////						estimateAmountRepository.getWorkflowNumber(consumerApplicationDetail.getErpWorkFlowNumber()));
////			}
////			;
////		}
//		System.err.println("converting pages to erp workflow end : " + LocalDateTime.now());
//		if (Objects.isNull(pages) || pages.isEmpty()) {
////			logger.error(
////					"consumerApplictionDetailRepository.findByConsumerApplicationDetailsPaginate is returning Null when findConsumerApplicationDetailPaginate call");
//			response.setCode(HttpCode.NULL_OBJECT);
//			response.setMessage(ResponseMessage.CONSUMER_APPLICATION_DETAIL_RECORDS_WITH_PAGINATION_FAILED_MESSAGE);
////			throw new ConsumerApplicationDetailException(response);
//			return pages;
//		} else {
////			logger.info("Response is returning successfully");
//			return pages;
//		}
//
//	}

//	@GetMapping("/getAllUserWiseConsumerApplicationPagination1")
//	Response getAllDataFromView() {
//
//		Response response = new Response();
//		System.err.println("before entering database  : " + LocalDateTime.now());
//		List<Map<String, Object>> craData = consumerApplictionDetailRepository.getAllDataFromView1();
//
//		System.err.println("After fetching data from database  : " + LocalDateTime.now());
//		if (craData.isEmpty()) {
//			response.setCode("404");
//			response.setMessage("Data not found");
//			return response;
//		}
//		response.setCode("200");
//		response.setMessage("Data found successfully");
//		response.setList(craData);
//		return response;
//	}
	
	
	@GetMapping("/getAllApplicationByStatusCount")
	Response getAllDataFromView() {

		Response response = new Response();
		System.err.println("before entering database  : " + LocalDateTime.now());
		List<Map<String, Object>> craData = consumerApplictionDetailRepository.getAllDataCount();

		System.err.println("After fetching data from database  : " + LocalDateTime.now());
		if (craData.isEmpty()) {
			response.setCode("404");
			response.setMessage("Data not found");
			return response;
		}
		response.setCode("200");
		response.setMessage("Data found successfully");
		response.setList(craData);
		return response;
	}
	
	
//	@GetMapping("/getApplicationData/{applicationStatusId}")
//	Response getAllApplicationByApplicationStatus(String applicationStatusId) {
//		Response response = new Response();
//		System.err.println("before entering database  : " + LocalDateTime.now());
//		List<Map<String, Object>> allApplicationByApplicationStatus = consumerApplictionDetailRepository.getAllApplicationByApplicationStatus(applicationStatusId);
//		System.err.println("After fetching data from database  : " + LocalDateTime.now());
//		if (allApplicationByApplicationStatus.isEmpty()) {
//			response.setCode("404");
//			response.setMessage("Data not found");
//			return response;
//		}
//		response.setCode("200");
//		response.setMessage("Data found successfully");
//		response.setList(allApplicationByApplicationStatus);
//		return response;
//	}
	
	@GetMapping("/getApplicationData/{applicationStatusId}")
	public Response getAllApplicationByApplicationStatus(@PathVariable String applicationStatusId) {
	    Response response = new Response();

	    // Convert comma-separated string to List<String>
	    List<String> statusIdList = Arrays.asList(applicationStatusId.split(","));

	    System.err.println("before entering database  : " + LocalDateTime.now());
	    List<Map<String, Object>> allApplicationByApplicationStatus = consumerApplictionDetailRepository.getAllApplicationByApplicationStatus(statusIdList);
	    System.err.println("After fetching data from database  : " + LocalDateTime.now());

	    if (allApplicationByApplicationStatus.isEmpty()) {
	        response.setCode("404");
	        response.setMessage("Data not found");
	        return response;
	    }
	    response.setCode("200");
	    response.setMessage("Data found successfully");
	    response.setList(allApplicationByApplicationStatus);
	    return response;
	}


}
