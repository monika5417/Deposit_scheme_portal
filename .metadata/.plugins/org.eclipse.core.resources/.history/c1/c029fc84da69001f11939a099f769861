package com.mpcz.deposit_scheme.backend.api.controller;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;

import javax.servlet.http.HttpServletResponse;

import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.mpcz.deposit_scheme.backend.api.constant.HttpCode;
import com.mpcz.deposit_scheme.backend.api.constant.ResponseMessage;
import com.mpcz.deposit_scheme.backend.api.constant.RestApiUrl;
import com.mpcz.deposit_scheme.backend.api.domain.Consumer;
import com.mpcz.deposit_scheme.backend.api.domain.ConsumerApplicationDetail;
import com.mpcz.deposit_scheme.backend.api.domain.User;
import com.mpcz.deposit_scheme.backend.api.dto.ConsumerApplicationDetailsFilterDTO;
import com.mpcz.deposit_scheme.backend.api.dto.TestDto;
import com.mpcz.deposit_scheme.backend.api.exception.ConsumerApplicationDetailException;
import com.mpcz.deposit_scheme.backend.api.exception.FormValidationException;
import com.mpcz.deposit_scheme.backend.api.exception.InvalidAuthenticationException;
import com.mpcz.deposit_scheme.backend.api.exception.PaymentTypeException;
import com.mpcz.deposit_scheme.backend.api.repository.BillPaymentResponseeeeeeeRepository;
import com.mpcz.deposit_scheme.backend.api.repository.ConsumerApplictionDetailRepository;
import com.mpcz.deposit_scheme.backend.api.repository.EstimateAmountRepository;
import com.mpcz.deposit_scheme.backend.api.response.Meta;
import com.mpcz.deposit_scheme.backend.api.response.PageConsumerApplicationDetailDTO;
import com.mpcz.deposit_scheme.backend.api.response.Response;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerApplicationDetailService;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerService;
import com.mpcz.deposit_scheme.backend.api.services.UserService;

import io.swagger.annotations.Api;
@CrossOrigin(origins = "*", maxAge = 3600)
@Api(value = "Testing Controller", description = "Rest api for ContractorDetailForBidController.")
@RestController
@RequestMapping("/api/user")
public class TestingController {
	
	
	@GetMapping("/getsp/{circleId}")
	// ParticipantAndNotParticipantDto getQcConsumerbid() throws Exception {
	ResponseEntity<Response<?>> getQcConsumerbid(@PathVariable Long circleId) throws Exception {
		
		Response<TestDto> response = new Response<>();

		TestDto dto=null;
		try {
			RestTemplate restTemplate = new RestTemplate();
			HttpHeaders headers = new HttpHeaders();
			headers.set("Content-Type", "application/json");
			String url = "https://rooftop-uat.mpcz.in:8443/security-deposit/circlemaster/circle/"+circleId;
			

			HttpEntity<String> entity = new HttpEntity<>(url, headers);
			ResponseEntity<String> responseEntity = restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
			
			String body = responseEntity.getBody();
			
			if(body != null) {
				
				JSONObject job = new JSONObject(body);
				
				if(job.getString("code").equals("200")) {
					
					
					String string = job.getString("message");
					System.out.println(string);
					
					
					JSONObject jsonObject = job.getJSONObject("object");
					System.out.println(jsonObject.getString("circleId"));
					System.out.println(jsonObject.getString("circleName"));
					System.out.println(jsonObject.getString("gmName"));
					System.out.println(jsonObject.getString("dgmStcName"));
					//System.out.println(jsonObject.getString("circleCode));
				
					 dto = new TestDto();
					
					dto.setMessage(string);
					//dto.setCircleCode(string);
					dto.setCircleId(circleId);
					dto.setCircleName(jsonObject.getString("circleName"));
					dto.setGmName(jsonObject.getString("gmName"));
					dto.setDgmStcName(jsonObject.getString("dgmStcName"));
			
				}
			
			}

		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();

		}

		response.setList(Arrays.asList(dto));
		response.setCode(HttpCode.OK);
		response.setMessage("Record Retrieve Successfully");

		return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);
	}
	
	
	
//	Monika code started for getAll application 
	
	@Autowired
	private ConsumerApplictionDetailRepository consumerApplictionDetailRepository;
	@Autowired
	ConsumerApplicationDetailService consumerApplicationDetailService;
	
	@Autowired
	private UserService userService;
	
	@Autowired
	BillPaymentResponseeeeeeeRepository billPaymentResponseeeeeeeRepository;
	
	@Autowired
	ConsumerService consumerService;
	
	@Autowired
	EstimateAmountRepository estimateAmountRepository;
	
	
	@GetMapping(RestApiUrl.GET_ALL_PAGINATE_URL)
	public ResponseEntity<Response<?>> getAllUserWiseConsumerApplicationPagination1(
			HttpServletResponse httpServletResponse) throws FormValidationException, InvalidAuthenticationException,
			ConsumerApplicationDetailException, PaymentTypeException {

		System.out.println("getAllUserWiseConsumerApplicationPagination !!!!!");

		final String method = RestApiUrl.USER_APPLICATION_DETAIL_API + RestApiUrl.GET_ALL_PAGINATE_URL
				+ " : getAllUserWiseConsumerApplicationPagination()";
//		LOG.info(method);

		Response<PageConsumerApplicationDetailDTO> response = new Response<>();

		String userLoginId = SecurityContextHolder.getContext().getAuthentication().getName();

		ConsumerApplicationDetailsFilterDTO filterDTO = new ConsumerApplicationDetailsFilterDTO();

		filterDTO.setUserLoginId(userLoginId);

		response = findAllConsumerApplicationDetailByApplicationStatusPagination(filterDTO);

		return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);

	}
	
	
	
	public Response<PageConsumerApplicationDetailDTO> findAllConsumerApplicationDetailByApplicationStatusPagination( ConsumerApplicationDetailsFilterDTO filterDTO)
			throws ConsumerApplicationDetailException {

		System.out.println("findAllConsumerApplicationDetailByApplicationStatusPagination method is calling !!!");

		Response<PageConsumerApplicationDetailDTO> response = new Response<PageConsumerApplicationDetailDTO>();
		PageConsumerApplicationDetailDTO pageConsumerApplicationDetailDTO = new PageConsumerApplicationDetailDTO();
		Page<ConsumerApplicationDetail> consumerApplicationDetails = findConsumerApplicationDetailByApplicationStatusPaginate(filterDTO);
		Map<String, Object> pageData = new HashMap<>();
		Meta meta = new Meta();
		meta.setCurrentPage(consumerApplicationDetails.getNumber());
		meta.setTotalItems(consumerApplicationDetails.getTotalElements());
		meta.setTotalPages(consumerApplicationDetails.getTotalPages());
		pageConsumerApplicationDetailDTO.setMeta(meta);
		List<ConsumerApplicationDetail> consumerApplicationDetailList = consumerApplicationDetails.getContent();
		for (ConsumerApplicationDetail cad : consumerApplicationDetailList) {
			List<Map<String, String>> transactionDateByConsumerApplicationNo = billPaymentResponseeeeeeeRepository
					.getTransactionDateByConsumerApplicationNo(cad.getConsumerApplicationNo());
			System.out.println("transactionDateByConsumerApplicationNo = " + transactionDateByConsumerApplicationNo);
			cad.setListOfTransactionDate(transactionDateByConsumerApplicationNo);
		}

		pageConsumerApplicationDetailDTO.setList(consumerApplicationDetailList);
		response.setList(Arrays.asList(pageConsumerApplicationDetailDTO));
		response.setCode("200");
		response.setMessage("All record retrieved successfully");
		return response;
	}
	
	public Page<ConsumerApplicationDetail> findConsumerApplicationDetailByApplicationStatusPaginate(ConsumerApplicationDetailsFilterDTO filterDTO) throws ConsumerApplicationDetailException {

		System.out.println("findConsumerApplicationDetailPaginate method is calling !!!");

		Response<ConsumerApplicationDetail> response = new Response<>();
//		Pageable paging = PageRequest.of(page, size);
		Page<ConsumerApplicationDetail> pages = null;
		Integer totalRecords = 0;

		if (filterDTO.getUserLoginId() != null) {

			User user = userService.findByUserId(filterDTO.getUserLoginId());

			switch (user.getAccessLevel()) {
			case "1":
				// discomId
				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());

				break;
			case "2":

				// regionId
				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());

				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
					filterDTO.setRegionId(user.getUserRegion().getRegionId());
				}

				break;
			case "3":
				// circleId
				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
					filterDTO.setRegionId(user.getUserRegion().getRegionId());
				}
				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
					filterDTO.setCircleId(user.getUserCircle().getCircleId());
				}

				break;
			case "4":
				// divisionId
				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
					filterDTO.setRegionId(user.getUserRegion().getRegionId());
				}
				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
					filterDTO.setCircleId(user.getUserCircle().getCircleId());
				}
				if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
					filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
				}

				break;
			case "5":
				// subDivisionId
				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
					filterDTO.setRegionId(user.getUserRegion().getRegionId());
				}
				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
					filterDTO.setCircleId(user.getUserCircle().getCircleId());
				}
				if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
					filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
				}
				filterDTO.setSubDivisionId(user.getUserSubDivision().getSubDivisionId());

				break;
			case "6":
				// dcId
				filterDTO.setDiscomId(user.getUserDiscom().getDiscomId());
				if (Optional.ofNullable(user.getUserRegion()).isPresent()) {
					filterDTO.setRegionId(user.getUserRegion().getRegionId());
				}
				if (Optional.ofNullable(user.getUserCircle()).isPresent()) {
					filterDTO.setCircleId(user.getUserCircle().getCircleId());
				}
				if (Optional.ofNullable(user.getUserDivision()).isPresent()) {
					filterDTO.setDivisionId(user.getUserDivision().getDivisionId());
				}
				filterDTO.setSubDivisionId(user.getUserSubDivision().getSubDivisionId());
				filterDTO.setDcId(user.getUserDc().getDcId());

				break;

			default:
				break;
			}

		}

		if (filterDTO.getConsumerLoginId() != null) {

			Consumer consumer = consumerService.findByConsumerLoginId(filterDTO.getConsumerLoginId());

			filterDTO.setConsumerId(consumer.getConsumerId());
		}

		pages = consumerApplictionDetailRepository.findByConsumerApplicationDetailsByApplicationStatusPaginate1(
				filterDTO.getDiscomId(), filterDTO.getRegionId(), filterDTO.getCircleId(), filterDTO.getDivisionId(),
				filterDTO.getSubDivisionId(), filterDTO.getDcId(), filterDTO.getConsumerId());

		List<ConsumerApplicationDetail> list = pages.get().collect(Collectors.toList());
		for (ConsumerApplicationDetail consumerApplicationDetail : list) {
			if (consumerApplicationDetail.getErpWorkFlowNumber() != null) {
				consumerApplicationDetail.setErpWorkFlowSacntion(
						estimateAmountRepository.getWorkflowNumber(consumerApplicationDetail.getErpWorkFlowNumber()));
			}
			;
		}

		if (Objects.isNull(pages) || pages.isEmpty()) {
//			logger.error(
//					"consumerApplictionDetailRepository.findByConsumerApplicationDetailsPaginate is returning Null when findConsumerApplicationDetailPaginate call");
			response.setCode(HttpCode.NULL_OBJECT);
			response.setMessage(ResponseMessage.CONSUMER_APPLICATION_DETAIL_RECORDS_WITH_PAGINATION_FAILED_MESSAGE);
//			throw new ConsumerApplicationDetailException(response);
			return pages;
		} else {
//			logger.info("Response is returning successfully");
			return pages;
		}

	}

	
	
	
	
	
	
	
	
	
	

}
