package com.mpcz.deposit_scheme.backend.api.controller;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.Arrays;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.mpcz.deposit_scheme.backend.api.constant.HttpCode;
import com.mpcz.deposit_scheme.backend.api.domain.ApplicationDocument;
import com.mpcz.deposit_scheme.backend.api.domain.ConsumerApplicationDetail;
import com.mpcz.deposit_scheme.backend.api.domain.ErpEstimateAmountData;
import com.mpcz.deposit_scheme.backend.api.domain.RefundProcessData;
import com.mpcz.deposit_scheme.backend.api.domain.Upload;
import com.mpcz.deposit_scheme.backend.api.exception.ConsumerApplicationDetailException;
import com.mpcz.deposit_scheme.backend.api.exception.DocumentTypeException;
import com.mpcz.deposit_scheme.backend.api.exception.ErpEstimateAmountException;
import com.mpcz.deposit_scheme.backend.api.repository.ApplicationDocumentRepository;
import com.mpcz.deposit_scheme.backend.api.repository.ConsumerApplictionDetailRepository;
import com.mpcz.deposit_scheme.backend.api.repository.RefundProcessDataRepository;
import com.mpcz.deposit_scheme.backend.api.request.ConsumerApplicationDetailForm;
import com.mpcz.deposit_scheme.backend.api.response.Response;
import com.mpcz.deposit_scheme.backend.api.services.ErpEstimateAmountService;
import com.mpcz.deposit_scheme.backend.api.services.UploadService;

@CrossOrigin(origins = "*", maxAge = 3600)
@RestController
@RequestMapping("/api/refund_process")
public class RefundProcessController {

	@Autowired
	private ConsumerApplictionDetailRepository consumerApplictionDetailRepository;

	@Autowired
	private ErpEstimateAmountService erpEstimateAmountService;

	@Autowired
	private RefundProcessDataRepository refundProcessDataRepository;

	@Autowired
	private UploadService uploadService;

	@Autowired
	private ApplicationDocumentRepository applicationDocumentRepository;


	@PostMapping("/saveRefundProcessData")
	public ResponseEntity<Response> saveRefundProcessData(@RequestPart("refundForm") String refundFormData,
			@RequestPart("docRefundLetter") Optional<MultipartFile> docRefundLetterFile,
			@RequestPart("docCheckOrPassBook") Optional<MultipartFile> docCheckOrPassBookFile)
			throws ErpEstimateAmountException, ConsumerApplicationDetailException, DocumentTypeException {
		Response response = new Response();

		Upload checkOrPassBookUpload = null;
		Upload refundLetterUpload = null;

		RefundProcessData refundData = RefundProcessController.stringToJson(refundFormData);

		ConsumerApplicationDetail findByConsumerApplicationNumber = consumerApplictionDetailRepository
				.findByConsumerApplicationNumber(refundData.getConsumerApplicationNo());
		if(findByConsumerApplicationNumber==null) {
			response.setMessage("Data not found for given application");
			return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
		}
		RefundProcessData refundProcessData = refundProcessDataRepository.findByConsumerApplicationNo(refundData.getConsumerApplicationNo());
		if(refundProcessData!=null) {
			response.setMessage("You have already raised application for refund");
			return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
		}
		ApplicationDocument applicationDocument = new ApplicationDocument();
		if (docRefundLetterFile.isPresent()) {
			refundLetterUpload = uploadService.uploadFile(docRefundLetterFile.get(), "REFUND_LETTER");
			if (refundLetterUpload == null) {
				response.setCode(HttpCode.NULL_OBJECT);
				response.setMessage("Document Refund Letter not uploaded.");
				throw new ConsumerApplicationDetailException(response);
			}
			applicationDocument.setDocRefundLetterFile(refundLetterUpload);
		}else {
			response.setMessage("Document Refund Letter Not Found");
			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
		}

		if (docCheckOrPassBookFile.isPresent()) {
			checkOrPassBookUpload = uploadService.uploadFile(docCheckOrPassBookFile.get(), "CHECK_OR_PASSBOOK");
			if (checkOrPassBookUpload == null) {
				response.setCode(HttpCode.NULL_OBJECT);
				response.setMessage("Document Cancel Check Or Passbook not uploaded.");
				throw new ConsumerApplicationDetailException(response);
			}
			applicationDocument.setDocCheckOrPassBookFile(checkOrPassBookUpload);
		}else {
			response.setMessage("Document Cancel Check Or Passbook Not Found");
			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
		}

		ApplicationDocument findByConsumerApplicationDetailId = applicationDocumentRepository
				.findByConsumerApplicationDetailId(findByConsumerApplicationNumber.getConsumerApplicationId());

		if (findByConsumerApplicationDetailId != null) {
			findByConsumerApplicationDetailId
					.setDocRefundLetterFile(applicationDocument.getDocRefundLetterFile());
			findByConsumerApplicationDetailId
					.setDocCheckOrPassBookFile(applicationDocument.getDocCheckOrPassBookFile());
			applicationDocumentRepository.save(findByConsumerApplicationDetailId);
		} else {
			applicationDocument.setConsumerApplicationDetail(findByConsumerApplicationNumber);
			applicationDocumentRepository.save(applicationDocument);
		}
	
		
		if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId() >= 12) {
			ErpEstimateAmountData findByEstimateNumber = erpEstimateAmountService
					.findByEstimateNumber(findByConsumerApplicationNumber.getErpWorkFlowNumber());
		
			BigDecimal cgst = findByEstimateNumber.getCgst();
			BigDecimal sgst = findByEstimateNumber.getSgst();
			BigDecimal totalBalanceSupervisionAmount = findByEstimateNumber.getTotalBalanceSupervisionAmount();
			BigDecimal totalBalanceDepositAmount = findByEstimateNumber.getTotalBalanceDepositAmount();
			BigDecimal jeReturnAmount = findByEstimateNumber.getJeReturnAmount();

			if (refundData.getValue() == 1) {
				if (findByConsumerApplicationNumber.getSchemeType().getSchemeTypeId().equals(1L)) {
					refundData.setRefundDemandAmnt(totalBalanceSupervisionAmount.subtract(cgst).subtract(sgst));
				} else {
					refundData.setRefundDemandAmnt(totalBalanceDepositAmount.subtract(cgst).subtract(sgst));
				}
			} else {
				refundData.setRefundJeReturnAmnt(jeReturnAmount);
			}

			RefundProcessData save = refundProcessDataRepository.save(refundData);
			response.setMessage("Refund data saved successfully");
			response.setList(Arrays.asList(save));
			return ResponseEntity.ok(response);
		} else {
			System.out.println("You are not eligible for refund amount");
			response.setMessage("You are not eligible for refund amount");
			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
		}
	}

	public static RefundProcessData stringToJson(String refundFormData) {
		RefundProcessData data = new RefundProcessData();
		try {
			ObjectMapper objectMapper = new ObjectMapper();
			data = objectMapper.readValue(refundFormData, RefundProcessData.class);
		} catch (IOException err) {
			err.printStackTrace();
		}
		return data;
	}

}
