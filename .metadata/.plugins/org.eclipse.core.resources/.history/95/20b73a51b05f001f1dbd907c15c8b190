package com.deposit_scheme_webhook.backend.api.controller;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.net.Proxy;
import java.net.URI;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.Random;
import java.util.Set;
import java.util.TreeMap;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.SimpleClientHttpRequestFactory;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.deposit_scheme_webhook.backend.api.domain.ApplicationStatus;
import com.deposit_scheme_webhook.backend.api.domain.BillDeskPaymentRequest1;
import com.deposit_scheme_webhook.backend.api.domain.BillDeskPaymentResponse;
import com.deposit_scheme_webhook.backend.api.domain.ConsumerApplicationDetail;
import com.deposit_scheme_webhook.backend.api.domain.ErpEstimateAmountData;
import com.deposit_scheme_webhook.backend.api.domain.ManualPayment;
import com.deposit_scheme_webhook.backend.api.domain.MmkyPayAmount;
import com.deposit_scheme_webhook.backend.api.domain.PoseMachinePostData;
import com.deposit_scheme_webhook.backend.api.dto.BilldeskPaymentRetriveProcess;
import com.deposit_scheme_webhook.backend.api.enums.ApplicationStatusEnum;
import com.deposit_scheme_webhook.backend.api.repository.BillPaymentResponseeeeeeeRepository;
import com.deposit_scheme_webhook.backend.api.repository.BllDeskPaymentRequestRepository;
import com.deposit_scheme_webhook.backend.api.repository.ConsumerApplictionDetailRepository;
import com.deposit_scheme_webhook.backend.api.repository.EstimateAmountRepository;
import com.deposit_scheme_webhook.backend.api.repository.ManualPaymentRepository;
import com.deposit_scheme_webhook.backend.api.repository.MmkyCalculationRepository;
import com.deposit_scheme_webhook.backend.api.repository.MmkyPayAmountRespository;
import com.deposit_scheme_webhook.backend.api.repository.PoseMachinePostDataRepository;
import com.deposit_scheme_webhook.backend.api.response.Response;
import com.deposit_scheme_webhook.backend.api.services.ApplicationStatusService;
import com.deposit_scheme_webhook.backend.api.services.BillDeskPaymentService;
import com.google.gson.Gson;
import com.mpcz.deposit_scheme.backend.api.constant.ResponseMessage;
import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.JOSEObjectType;
import com.nimbusds.jose.JWSAlgorithm;
import com.nimbusds.jose.JWSHeader;
import com.nimbusds.jose.JWSObject;
import com.nimbusds.jose.JWSSigner;
import com.nimbusds.jose.JWSVerifier;
import com.nimbusds.jose.Payload;
import com.nimbusds.jose.crypto.MACSigner;
import com.nimbusds.jose.crypto.MACVerifier;
import com.nimbusds.jose.jwk.JWK;
import com.nimbusds.jose.util.Base64URL;

@CrossOrigin(
   origins = {"*"},
   maxAge = 3600L
)
@RestController
@RequestMapping({"/api/consumer/bill-desk"})
public class BillPaymentProcessController {
   @Autowired(
      required = false
   )
   BillDeskPaymentService billPaymentService;
   @Autowired
   BllDeskPaymentRequestRepository billDeskPaymentRequestRepository;
   @Autowired
   BillPaymentResponseeeeeeeRepository billPaymentResponseeeeeeeRepository;
   @Autowired
   ConsumerApplictionDetailRepository consumerApplictionDetailRepository;
   @Autowired
   ApplicationStatusService applicationStatusService;
   @Autowired
   MmkyCalculationRepository mmkyCalculationRepository;
   @Autowired
   EstimateAmountRepository estimateAmountRepository;
   @Autowired
   MmkyPayAmountRespository mmkyPayAmountRespository;
   @Autowired
   ManualPaymentRepository manualPaymentRepository;
   @Autowired
   private PoseMachinePostDataRepository poseMachinePostDataRepository;
   
   
   @Value("${client.id}")
   private String clientId;
   @Value("${return.url}")
   private String returnUrl;
   @Value("${hash.key}")
   private String hashKey;
   @Value("${client.key}")
   private String clientKey;
   @Value("${create.order}")
   private String createOrder;
   @Value("${ravindra.send.data.after.payment}")
   private String ravindraSendDataAfterPayment;
   @Value("${transaction.url}")
   private String transactionUrl;
   @Value("${refund.create}")
   private String refundCreate;
   private static final Logger logger = LoggerFactory.getLogger(BillPaymentProcessController.class);

   private String encryptAndSignJWSWithHMAC(String reqStr, String secretKey, String clientid) throws JOSEException {

		JWSSigner signer = new MACSigner(secretKey);
		HashMap<String, Object> customParams = new HashMap<String, Object>();
		customParams.put("clientid", clientid);
		JWSHeader jwsHeader = new JWSHeader(JWSAlgorithm.HS256, null, null, null, null, null, null, null, null, null,
				null, customParams, null);
		JWSObject jwsObject = new JWSObject(jwsHeader, new Payload(reqStr)); // Apply the HMAC
		jwsObject.sign(signer);
		return jwsObject.serialize();
	}

   public String verifyAndDecryptJWSWithHMAC(String encryptedSignedMessage, String verificationKey) throws Exception {
      JWSObject jwsObject = JWSObject.parse(encryptedSignedMessage);
      logger.info("jwsObject : " + jwsObject);
      String clientId = jwsObject.getHeader().getCustomParam("clientid").toString();
      System.out.println("clientId = " + clientId);
      JWSVerifier verifier = new MACVerifier(verificationKey);
      boolean isVerified = jwsObject.verify(verifier);
      System.out.println("is valid " + isVerified);
      String message = jwsObject.getPayload().toString();
      logger.info("message : " + message);
      return message;
   }

   @PostMapping(
      value = {"/save_payment_response"},
      consumes = {"application/x-www-form-urlencoded;charset=UTF-8"}
   )
   public void savePaymentResponse(HttpServletRequest request, HttpServletResponse response1) throws IOException {
      logger.info("Inside savePaymentResponse() : ");
      logger.info(" HttpServletRequest request : " + request);
      logger.info("HttpServletResponse response1 : " + response1);
      System.out.println(request);
      Map<String, String[]> map = request.getParameterMap();
      HttpSession session = request.getSession(true);
      String respString = (new Gson()).toJson(map.toString());
      response1.setContentType("text/html");
      response1.getWriter().write(respString.toString());
      System.out.println("Response-" + respString.toString());
      new Response();
      BillDeskPaymentResponse payres = null;
      TreeMap<String, String> paytmParams = new TreeMap();
      Object var9 = null;

      try {
         Set set = map.entrySet();
         TreeMap<String, String> tree_map = new TreeMap();
         Iterator it = set.iterator();

         while(it.hasNext()) {
            Entry<String, String[]> entry = (Entry)it.next();
            paytmParams.put((String)entry.getKey(), ((String[])entry.getValue())[0]);
            tree_map.put((String)entry.getKey(), ((String[])entry.getValue())[0]);
         }

         payres = new BillDeskPaymentResponse();
         String string = (String)tree_map.get("transaction_response");
         System.out.println(string);
         System.out.println(tree_map);
         String verifyAndDecryptJWSWithHMAC = this.verifyAndDecryptJWSWithHMAC(string, this.hashKey);
         System.out.println(verifyAndDecryptJWSWithHMAC);
         JSONObject jobObject = new JSONObject(verifyAndDecryptJWSWithHMAC);
         payres.setMercid(jobObject.getString("mercid"));
         payres.setAmount(jobObject.getString("amount"));
         payres.setAuth_status(jobObject.getString("auth_status"));
         payres.setBankId(jobObject.getString("bankid"));
         payres.setBankRefNo(jobObject.getString("bank_ref_no"));
         payres.setChargeAmount(jobObject.getString("charge_amount"));
         payres.setCurrency(jobObject.getString("currency"));
         payres.setObjectId(jobObject.getString("objectid"));
         payres.setOrderid(jobObject.getString("orderid"));
         payres.setPaymentMethodType(jobObject.getString("payment_method_type"));
         payres.setRu(jobObject.getString("ru"));
         payres.setSurcharge(jobObject.getString("surcharge"));
         payres.setTranErrorCode(jobObject.getString("transaction_error_code"));
         payres.setTranErrorDesc(jobObject.getString("transaction_error_desc"));
         payres.setTranId(jobObject.getString("transactionid"));
         payres.setTranProcessType(jobObject.getString("txn_process_type"));
         payres.setTransactionDate(jobObject.getString("transaction_date"));
         payres.setConsumerApplicationNo(jobObject.getJSONObject("additional_info").getString("additional_info3"));
         payres.setConsumerName(jobObject.getJSONObject("additional_info").getString("additional_info1"));
         payres.setMobileNo(jobObject.getJSONObject("additional_info").getString("additional_info2"));
         payres.setAdditionalInfo(jobObject.getJSONObject("additional_info").getString("additional_info7"));
         String consumerApp = jobObject.getJSONObject("additional_info").getString("additional_info3");
         ConsumerApplicationDetail findByConsumerApplicationNumber = this.consumerApplictionDetailRepository.findByConsumerApplicationNumber(consumerApp);
         logger.info("Response Applicaiton No : " + consumerApp);
         logger.info("Response Transaction Id : " + jobObject.getString("transactionid"));
         logger.info("Response Transaction Amount : " + jobObject.getString("amount"));
         logger.info("Response Transaction Date : " + jobObject.getString("transaction_date"));
         logger.info("payers data : " + payres);
         ApplicationStatus appStatusDb = null;
         Date currentDate = new Date();
         Calendar calendar = Calendar.getInstance();
         calendar.setTime(currentDate);
         calendar.add(5, 3);
         Date newDate = calendar.getTime();
         SimpleDateFormat formatter = new SimpleDateFormat("dd-MM-yyyy");
         String currentDateFormatted = formatter.format(currentDate);
         String newDateFormatted = formatter.format(newDate);
         System.out.println("Current Date: " + currentDateFormatted);
         System.out.println("New Date: " + newDateFormatted);
         if (jobObject.getString("auth_status").equals("0300")) {
            if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId().equals(5L)) {
               appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.ACCEPTANCE_OF_APPLICATION_AT_DC.getId());
            } else if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId().equals(12L)) {
               if (!findByConsumerApplicationNumber.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Deposit") && findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId() != 8L) {
                  if (findByConsumerApplicationNumber.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Supervision") && !findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId().equals(5L)) {
                     appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.PENDING_FOR_SELECTING_CONTRACTOR.getId());
                  } else if (findByConsumerApplicationNumber.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Supervision") && findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId().equals(5L)) {
                     appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.WAITING_FOR_72_HOURS.getId());
                     findByConsumerApplicationNumber.setPaymentDate(newDateFormatted);
                  }
               } else {
                  appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.PENDING_FOR_WORK_ORDER.getId());
               }
            } else if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId().equals(30L)) {
               appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.PENDING_FOR_WORK_ORDER.getId());
            }
         } else if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId().equals(5L)) {
            appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.PENDING_FOR_REGISTRATION_FEES.getId());
         } else {
            appStatusDb = this.applicationStatusService.findById(ApplicationStatusEnum.DEMAND_PAYMENT_PENDING_BY_CONSUMER.getId());
         }

         findByConsumerApplicationNumber.setApplicationStatus(appStatusDb);
         logger.info("Application status saved : " + appStatusDb);
         System.out.println(payres + "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz");
         Integer count = this.billPaymentResponseeeeeeeRepository.getByTransactionId(payres.getTranId());
         logger.info("count from Billdesk table : " + count);
         BillDeskPaymentResponse save = null;
         if (count == null || count == 0) {
            findByConsumerApplicationNumber.setApplicationStatus(appStatusDb);
            logger.info("Application status saved after billdesk table count : " + appStatusDb);
            save = (BillDeskPaymentResponse)this.billPaymentResponseeeeeeeRepository.save(payres);
            logger.info("Details after saving in Billdesk table : " + save);
            if (save != null) {
               ConsumerApplicationDetail save2 = (ConsumerApplicationDetail)this.consumerApplictionDetailRepository.save(findByConsumerApplicationNumber);
               logger.info("Data saved in consumerApplicaiton Detail table after billdesk response save : " + save2);
               if (save2.getApplicationStatus().getApplicationStatusId().equals(23L) && save2.getErpVersion() == null || save2.getApplicationStatus().getApplicationStatusId().equals(21L) || save2.getApplicationStatus().getApplicationStatusId().equals(20L)) {
                  Map<String, String> requestBody = new HashMap();
                  if (findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId() == 8L) {
                     MmkyPayAmount findByConsumer = this.mmkyPayAmountRespository.findByConsumerApplicationNumber(findByConsumerApplicationNumber.getConsumerApplicationNo());
                     logger.info("MKMY Consumer payment data" + findByConsumer);
                     requestBody.put("consumerApplicationNo", findByConsumerApplicationNumber.getConsumerApplicationNo());
                     requestBody.put("schema", findByConsumer.getSchemeCode());
                  } else {
                     Optional<ErpEstimateAmountData> findById = this.estimateAmountRepository.findById(findByConsumerApplicationNumber.getErpWorkFlowNumber());
                     if (findById.isPresent()) {
                        logger.info("ERP table data " + findById);
                        ErpEstimateAmountData erpEstimateAmountData = (ErpEstimateAmountData)findById.get();
                        String kwLoad = String.valueOf(erpEstimateAmountData.getKwLoad());
                        requestBody.put("kwload", kwLoad);
                        String kvaLoad = String.valueOf(erpEstimateAmountData.getKvaLoad());
                        requestBody.put("kvaload", kvaLoad);
                        String depositAmount = String.valueOf(erpEstimateAmountData.getDepositAmount());
                        requestBody.put("deposit_amount", depositAmount);
                        String superVisionAmt = String.valueOf(erpEstimateAmountData.getSupervisionAmount());
                        requestBody.put("supervision_amount", superVisionAmt);
                        String sgst = String.valueOf(erpEstimateAmountData.getSgst());
                        requestBody.put("sgst", sgst);
                        String cgst = String.valueOf(erpEstimateAmountData.getCgst());
                        requestBody.put("cgst", cgst);
                        requestBody.put("estimate_name", erpEstimateAmountData.getEstimateName());
                        requestBody.put("schema", erpEstimateAmountData.getSchemeCode());
                     }
                  }

                  requestBody.put("consumer_mobile_no", findByConsumerApplicationNumber.getConsumers().getConsumerMobileNo());
                  requestBody.put("consumerApplicationNo", findByConsumerApplicationNumber.getConsumerApplicationNo());
                  requestBody.put("consumer_email_id", findByConsumerApplicationNumber.getConsumers().getConsumerEmailId());
                  requestBody.put("address", findByConsumerApplicationNumber.getAddress());
                  requestBody.put("shortDescriptionOfWork", findByConsumerApplicationNumber.getShortDescriptionOfWork());
                  requestBody.put("erp_no", findByConsumerApplicationNumber.getErpWorkFlowNumber());
                  requestBody.put("consumerName", findByConsumerApplicationNumber.getConsumerName());
                  requestBody.put("is_bid_submitted", "false");
                  logger.info("requestBody data send to ravindra after payment : " + requestBody);
                  RestTemplate restTemplate = new RestTemplate();
                  ResponseEntity<Map> postForEntity = restTemplate.postForEntity(this.ravindraSendDataAfterPayment, requestBody, Map.class, new Object[0]);
                  logger.info("Data returned after hit of Ravindra contractor api  : " + postForEntity.getBody());
                  System.out.println("The result of Post api is :" + postForEntity.getBody());
               }
            }
         }

         if (save != null) {
            String redirectUrl = "sendReciept?accountId=" + payres.getConsumerApplicationNo() + "&custName=" + payres.getConsumerName() + "&orderId=" + payres.getOrderid() + "&txnId=" + payres.getTranId() + "&txnAmount=" + payres.getAmount() + "&txnDate=" + payres.getTransactionDate() + "&status=" + payres.getTranErrorDesc() + "&isFailed=" + Boolean.FALSE;
            response1.sendRedirect(redirectUrl);
            logger.info("redirectUrl : " + redirectUrl);
         }
      } catch (Exception var37) {
         logger.info("Exception " + var37);
         response1.sendRedirect("sendReciept?msg=" + (String)paytmParams.get("RESPMSG") + "&isFailed=" + Boolean.TRUE + "&isFailedParam=" + Boolean.FALSE);
      }

   }

   @GetMapping({"/sendReciept"})
   public String sendReciept(@RequestParam(value = "accountId",required = false) String accountId, @RequestParam(value = "custName",required = false) String custName, @RequestParam(value = "orderId",required = false) String orderId, @RequestParam(value = "txnId",required = false) String txnId, @RequestParam(value = "txnAmount",required = false) String txnAmount, @RequestParam(value = "txnDate",required = false) String txnDate, @RequestParam(value = "status",required = false) String status, @RequestParam("isFailed") boolean isFailed, @RequestParam(value = "isFailedParam",required = false) boolean isFailedParam, @RequestParam(value = "msg",required = false) String msg, HttpServletRequest request) throws Exception {
      String reciept = "";
      HttpSession session = request.getSession(true);
      if (isFailed) {
         if (isFailedParam) {
            reciept = this.generateFailRecipt(accountId, custName, orderId, txnId, txnAmount, txnDate, status);
         } else {
            reciept = this.generateFailRecipt(msg);
         }
      } else {
         reciept = this.generateRecipt(accountId, custName, orderId, txnId, txnAmount, txnDate, status);
      }

      return reciept;
   }

   private String generateFailRecipt(String msg) throws ParseException, Exception {
      StringBuilder recipt = new StringBuilder();
      recipt.append("<html><head>");
      recipt.append("<script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js\"></script>");
      recipt.append("<style>table, td, th {border: 1px solid black;}</style>");
      recipt.append("<script type=\"text/javascript\">$(document).ready(function(){$(\"#btn\").click(function () {$(\"#printarea\").print();window.print();});});</script></head><body>\r\n");
      recipt.append("<div id=\"printableArea\"><table align=\"center\" width=\"60%\" id=\"printarea\" cellpadding=\"10\" cellspacing=\"0\" style=\" border-collapse: collapse; border: 1px solid black;\"><thead>\r\n");
      recipt.append("<tr><th colspan=\"2\" style=' height: 50px;'><b>Transaction Fail Kindly retry!!</b>" + msg + "</th></tr></thead><tbody></tbody></table><br><br></div>\r\n");
      recipt.append("<center><button name=\"print\" onclick=\"printDiv('printableArea')\" id=\"btn\" >Print Receipt</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button name='close' id='btn'  onclick='window.close();return false;'>Close Window</button></center>\r\n</td></tr></tfoot></div></body>\r\n<script>function printDiv(divName) {var printContents = document.getElementById(divName).innerHTML;var originalContents = document.body.innerHTML;document.body.innerHTML = printContents;window.print();document.body.innerHTML = originalContents;}</script><script type = \"text/javascript\"> $(document).on(\"keydown\", function (e) {\r\n        if (e.key == \"F5\" || e.key == \"F11\" || \r\n            (e.ctrlKey == true && (e.key == 'r' || e.key == 'R')) || \r\n            e.keyCode == 116 || e.keyCode == 82) {\r\n                   e.preventDefault();\r\n        }\r\n    $(window).bind('beforeunload', function(e) {  \r\n\t   return \\\"Unloading this page may lose data. What do you want to do... \r\n\t   e.preventDefault(); \r\n\t}); });</script></html>");
      return recipt.toString();
   }

   private String generateRecipt(String accountId, String custName, String orderId, String txnId, String txnAmount, String txnDate, String status) throws ParseException, Exception {
      StringBuilder recipt = new StringBuilder();
      recipt.append("<html><head>");
      recipt.append("<script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js\"></script>");
      recipt.append("<style>table, td, th {border: 1px solid black;}</style>");
      recipt.append("<script type=\"text/javascript\">$(document).ready(function(){$(\"#btn\").click(function () {$(\"#printarea\").print();window.print();});});</script></head><body>\r\n");
      recipt.append("<div id=\"printableArea\"><table align=\"center\" width=\"60%\" id=\"printarea\" cellpadding=\"10\" cellspacing=\"0\" style=\" border-collapse: collapse; border: 1px solid black;\"><thead>\r\n");
      recipt.append("<tr><th colspan=\"2\" style=' height: 50px;'><b>PAYMENT RECEIPT</b></th></tr></thead><tbody>");
      recipt.append("<tr><td style='font-weight:bold'>APPLICATION No.</td><td style='color:blue'>" + accountId + "</td></tr>");
      recipt.append("<tr><td style='font-weight:bold'>APPLICANT NAME</td><td style='color:blue'>" + custName + "</td></tr>\r\n");
      recipt.append("</td></tr>\r\n<tr><td style='font-weight:bold'>TRANSACTION NO</td><td style='color:blue'>" + txnId + "</td></tr>\r\n<tr><td style='font-weight:bold'>AMOUNT</td><td style='color:blue'>" + txnAmount + "</td></tr>\r\n<tr><td style='font-weight:bold'>DATE</td><td style='color:blue'>" + txnDate + "</td></tr>\r\n<tr><td style='font-weight:bold'>Payment received towards against your application</td><td style='color:blue'>" + status + "</td></tr>\r\n</tbody></table><br><br></div>\r\n");
      recipt.append("<center><button name=\"print\" onclick=\"printDiv('printableArea')\" id=\"btn\" >Print Receipt</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button name='close' id='btn'  onclick='window.close();return false;'>Close Window</button></center>\r\n</td></tr></tfoot></div></body>\r\n<script>function printDiv(divName) {var printContents = document.getElementById(divName).innerHTML;var originalContents = document.body.innerHTML;document.body.innerHTML = printContents;window.print();document.body.innerHTML = originalContents;}</script>\r\n<script type = \"text/javascript\"> $(document).on(\"keydown\", function (e) {\r\n        if (e.key == \"F5\" || e.key == \"F11\" || \r\n            (e.ctrlKey == true && (e.key == 'r' || e.key == 'R')) || \r\n            e.keyCode == 116 || e.keyCode == 82) {\r\n                   e.preventDefault();\r\n    $(window).bind('beforeunload', function(e) { \r\n\t   return \\\"Unloading this page may lose data. What do you want to do... \r\n\t   e.preventDefault(); \r\n\t});});</script></html>");
      return recipt.toString();
   }

   private String generateFailRecipt(String accountId, String custName, String orderId, String txnId, String txnAmount, String txnDate, String status) throws ParseException, Exception {
      StringBuilder recipt = new StringBuilder();
      recipt.append("<html><head>");
      recipt.append("<script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js\"></script>");
      recipt.append("<style>table, td, th {border: 1px solid black;}</style>");
      recipt.append("<script type=\"text/javascript\">$(document).ready(function(){$(\"#btn\").click(function () {$(\"#printarea\").print();window.print();});});</script></head><body>\r\n");
      recipt.append("<div id=\"printableArea\"><table align=\"center\" width=\"60%\" id=\"printarea\" cellpadding=\"10\" cellspacing=\"0\" style=\" border-collapse: collapse; border: 1px solid black;\"><thead>\r\n");
      recipt.append("<tr><th colspan=\"2\" style=' height: 50px;'><b>Transaction Fail Kindly Retry !!</b></th></tr></thead><tbody>");
      recipt.append("<tr><td style='font-weight:bold'>APPLICATION No.</td><td style='color:blue'>" + accountId + "</td></tr>");
      recipt.append("</td></tr>\r\n<tr><td style='font-weight:bold'>TRANSACTION NO</td><td style='color:blue'>" + txnId + "</td></tr>\r\n<tr><td style='font-weight:bold'>AMOUNT</td><td style='color:blue'>" + txnAmount + "</td></tr>\r\n<tr><td style='font-weight:bold'>DATE</td><td style='color:blue'>" + txnDate + "</td></tr>\r\n<tr><td style='font-weight:bold'>Payment received towards  against your application</td><td style='color:blue'>" + status + "</td></tr>\r\n</tbody></table><br><br></div>\r\n");
      recipt.append("<center><button name=\"print\" onclick=\"printDiv('printableArea')\" id=\"btn\" >Print Receipt</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button name='close' id='btn'  onclick='window.close();return false;'>Close Window</button></center>\r\n</td></tr></tfoot></div></body>\r\n<script>function printDiv(divName) {var printContents = document.getElementById(divName).innerHTML;var originalContents = document.body.innerHTML;document.body.innerHTML = printContents;window.print();document.body.innerHTML = originalContents;}</script>\r\n<script type = \"text/javascript\"> $(document).on(\"keydown\", function (e) {\r\n        if (e.key == \"F5\" || e.key == \"F11\" || \r\n            (e.ctrlKey == true && (e.key == 'r' || e.key == 'R')) || \r\n            e.keyCode == 116 || e.keyCode == 82) {\r\n                   e.preventDefault();\r\n        }\r\n   $(window).bind('beforeunload', function(e) { \r\n\t\t return \\\"Unloading this page may lose data. What do you want to do... \r\n\t\t  e.preventDefault();\r\n\t\t}); });</script></html>");
      return recipt.toString();
   }

   @PostMapping("/Billdesk_payment_retrive_api")
	public Response<Object> billdeskPaymentRetriveProcess(
			@RequestBody BilldeskPaymentRetriveProcess billdeskPaymentRetriveProcess) {
		Response<Object> response = new Response<Object>();
		try {

//			BillDeskPaymentResponse billDeskPaymentResponse = billPaymentResponseeeeeeeRepository
//					.findByOrderid(billdeskPaymentRetriveProcess.getOrderid());

			BillDeskPaymentResponse billDeskPaymentResponse = billPaymentResponseeeeeeeRepository
					.findByTranId(billdeskPaymentRetriveProcess.getTransactionid());
			if (billDeskPaymentResponse != null) {
				response.setMessage("data already exist.");
				return response;
			}

			JSONObject createObjectForbillDesk = new JSONObject();

//			uat code 
//			createObjectForbillDesk.put("mercid", clientId);
//			createObjectForbillDesk.put("orderid", billdeskPaymentRetriveProcess.getOrderid());
//			String convertObjectInString = encryptAndSignJWSWithHMAC(createObjectForbillDesk.toString(),
//					hashKey, clientKey);

//			producation code		
//			createObjectForbillDesk.put("orderid", billdeskPaymentRetriveProcess.getOrderid());		
//
			createObjectForbillDesk.put("mercid", clientId);
			createObjectForbillDesk.put("transactionid", billdeskPaymentRetriveProcess.getTransactionid());
			String convertObjectInString = encryptAndSignJWSWithHMAC(createObjectForbillDesk.toString(),
					hashKey, clientKey);

			SimpleClientHttpRequestFactory clientHttpReq = new SimpleClientHttpRequestFactory();
			Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress("proxy.mpcz.in", 8080));
			clientHttpReq.setProxy(proxy);

			RestTemplate restTemplate = new RestTemplate(clientHttpReq);

			HttpHeaders headers = new HttpHeaders();

			Long time = Timestamp.valueOf(LocalDateTime.now()).getTime();
			System.out.println("valueOf--->" + time.toString());
			headers.set("Content-Type", "application/jose");
			headers.set("BD-timestamp", time.toString());
			headers.set("Accept", "application/jose");
			headers.set("BD-traceid", time.toString() + "123");

//			uat url
			String url = transactionUrl;

//			production url
//			String url = "https://api.billdesk.com/payments/ve1_2/transactions/get";

			HttpEntity httpEntity = new HttpEntity<>(convertObjectInString, headers);
			System.err.println("httpEntity-->" + httpEntity);

			ResponseEntity<String> postForEntity = restTemplate.postForEntity(url, httpEntity, String.class);

			System.err.println("postForEntity-->" + postForEntity);
			String forObject = postForEntity.getBody();
			System.out.println("forObject-------------" + forObject);
			if (forObject == null && forObject.length() <= 0) {
				response.setMessage("response body is null");
				response.setCode("200");
				return response;
			}

//			uat  code
			String verifyAndDecryptJWSWithHMAC = verifyAndDecryptJWSWithHMAC(forObject,
					hashKey);

//			production code
//			String verifyAndDecryptJWSWithHMAC = verifyAndDecryptJWSWithHMAC(forObject,
//					"IJLmg3QiLBnDwb3IoeK13eXcYcvHVdP6");

			JSONObject jobObject = new JSONObject(verifyAndDecryptJWSWithHMAC);
			System.out.println(jobObject.getString("auth_status").equalsIgnoreCase("0300"));

			if (jobObject.getString("auth_status").equalsIgnoreCase("0300")) {
				String saveResponseBillDeskTable = saveResponseBillDeskTable(jobObject);
				if (saveResponseBillDeskTable.equals("data save")) {
					response.setMessage("data save payment Response class");
				}
			} else {
				response.setMessage("payment not successfull");
				return response;
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
		return response;

	}
   
   public String saveResponseBillDeskTable(JSONObject jobObject) {
		BillDeskPaymentResponse payres = new BillDeskPaymentResponse();
		try {
//			uat ki mercId
			payres.setMercid(clientId);

//			prod ka mercId
//			payres.setMercid("MPMKDSPV2");

			payres.setAmount(jobObject.getString("amount"));
			payres.setAuth_status(jobObject.getString("auth_status"));
			payres.setBankId(jobObject.getString("bankid"));
			payres.setBankRefNo(jobObject.getString("bank_ref_no"));
			payres.setChargeAmount(jobObject.getString("charge_amount"));
			payres.setCurrency(jobObject.getString("currency"));
			payres.setObjectId(jobObject.getString("objectid"));
			payres.setOrderid(jobObject.getString("orderid"));
			payres.setPaymentMethodType(jobObject.getString("payment_method_type"));
			payres.setRu(jobObject.getString("ru"));
			payres.setSurcharge(jobObject.getString("surcharge"));
			payres.setTranErrorCode(jobObject.getString("transaction_error_code"));
			payres.setTranErrorDesc(jobObject.getString("transaction_error_desc"));
			payres.setTranId(jobObject.getString("transactionid"));
			payres.setTranProcessType(jobObject.getString("txn_process_type"));
			payres.setTransactionDate(jobObject.getString("transaction_date"));
			payres.setConsumerApplicationNo(jobObject.getJSONObject("additional_info").getString("additional_info3"));
			payres.setConsumerName(jobObject.getJSONObject("additional_info").getString("additional_info1"));
			payres.setMobileNo(jobObject.getJSONObject("additional_info").getString("additional_info2"));
			String consumerApp = jobObject.getJSONObject("additional_info").getString("additional_info3");
			ConsumerApplicationDetail findByConsumerApplicationNumber = consumerApplictionDetailRepository
					.findByConsumerApplicationNumber(consumerApp);
			ApplicationStatus appStatusDb = null;
			if (jobObject.getString("auth_status").equalsIgnoreCase("0300")) {
				if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId() == 5l) {

					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.ACCEPTANCE_OF_APPLICATION_AT_DC.getId());
				} else if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId() == 12l) {
					if (findByConsumerApplicationNumber.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Deposit")
							|| findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId()
									.equals(8L)) {
						appStatusDb = applicationStatusService
								.findById(ApplicationStatusEnum.PENDING_FOR_WORK_ORDER.getId());
					} else if (findByConsumerApplicationNumber.getSchemeType().getSchemeTypeName()
							.equalsIgnoreCase("Supervision")
							&& findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId() != 5l) {
						appStatusDb = applicationStatusService
								.findById(ApplicationStatusEnum.PENDING_FOR_SELECTING_CONTRACTOR.getId());
					} else {
						appStatusDb = applicationStatusService
								.findById(ApplicationStatusEnum.WAITING_FOR_72_HOURS.getId());
					}
					Date currentDate = new Date();

					// Create a calendar instance and set it to the current date
					Calendar calendar = Calendar.getInstance();
					calendar.setTime(currentDate);

					// Add three days to the current date
					calendar.add(Calendar.DAY_OF_MONTH, 3);

					// Get the new date
					Date newDate = calendar.getTime();

					// Create a formatter for the desired date format
					SimpleDateFormat formatter = new SimpleDateFormat("dd-MM-yyyy");

					// Format the dates using the formatter
					String currentDateFormatted = formatter.format(currentDate);
					String newDateFormatted = formatter.format(newDate);

					// Display the current date and the new date
					System.out.println("Current Date: " + currentDateFormatted);
					System.out.println("New Date: " + newDateFormatted);

					if (!findByConsumerApplicationNumber.getSchemeType().getSchemeTypeName()
							.equalsIgnoreCase("Supervision")) {
						findByConsumerApplicationNumber.setPaymentDate(newDateFormatted);
					}
				}

				else {
					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.PENDING_FOR_REGISTRATION_FEES.getId());
				}
			} else {
				if (findByConsumerApplicationNumber.getApplicationStatus().getApplicationStatusId() == 5l) {
					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.PENDING_FOR_REGISTRATION_FEES.getId());
				} else {
					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.DEMAND_PAYMENT_PENDING_BY_CONSUMER.getId());
				}
			}
			findByConsumerApplicationNumber.setApplicationStatus(appStatusDb);
			consumerApplictionDetailRepository.save(findByConsumerApplicationNumber);

			BillDeskPaymentResponse save = billPaymentResponseeeeeeeRepository.save(payres);
			if (save == null) {
//				return "data not save";
			} else {
				ConsumerApplicationDetail save2 = consumerApplictionDetailRepository
						.save(findByConsumerApplicationNumber);
				// Code for sending data to QC portal when payment done
				if ((save2.getApplicationStatus().getApplicationStatusId().equals(23L)
						&& save2.getErpVersion() == null)
						|| save2.getApplicationStatus().getApplicationStatusId().equals(21L)
						|| save2.getApplicationStatus().getApplicationStatusId().equals(20L)) {
					Map<String, String> requestBody = new HashMap<>();

					if (findByConsumerApplicationNumber.getNatureOfWorkType().getNatureOfWorkTypeId() == 8L) {
						MmkyPayAmount findByConsumer = mmkyPayAmountRespository.findByConsumerApplicationNumber(
								findByConsumerApplicationNumber.getConsumerApplicationNo());
						requestBody.put("consumerApplicationNo",
								findByConsumerApplicationNumber.getConsumerApplicationNo());
						requestBody.put("schema", findByConsumer.getSchemeCode());
						
					} else {

						Optional<ErpEstimateAmountData> findById = estimateAmountRepository
								.findById(findByConsumerApplicationNumber.getErpWorkFlowNumber());
						if (findById.isPresent()) {
							ErpEstimateAmountData erpEstimateAmountData = findById.get();
							String kwLoad = String.valueOf(erpEstimateAmountData.getKwLoad());
							requestBody.put("kwload", kwLoad);

							String kvaLoad = String.valueOf(erpEstimateAmountData.getKvaLoad());
							requestBody.put("kvaload", kvaLoad);

							String depositAmount = String.valueOf(erpEstimateAmountData.getDepositAmount());
							requestBody.put("deposit_amount", depositAmount);

							String superVisionAmt = String.valueOf(erpEstimateAmountData.getSupervisionAmount());
							requestBody.put("supervision_amount", superVisionAmt);

							String sgst = String.valueOf(erpEstimateAmountData.getSgst());
							requestBody.put("sgst", sgst);

							String cgst = String.valueOf(erpEstimateAmountData.getCgst());
							requestBody.put("cgst", cgst);

							requestBody.put("estimate_name", erpEstimateAmountData.getEstimateName());
							requestBody.put("schema", erpEstimateAmountData.getSchemeCode());

						}
					}

					requestBody.put("consumer_mobile_no",
							findByConsumerApplicationNumber.getConsumers().getConsumerMobileNo());
					requestBody.put("consumerApplicationNo",
							findByConsumerApplicationNumber.getConsumerApplicationNo());
					requestBody.put("consumer_email_id",
							findByConsumerApplicationNumber.getConsumers().getConsumerEmailId());

					requestBody.put("address", findByConsumerApplicationNumber.getAddress());

					requestBody.put("shortDescriptionOfWork",
							findByConsumerApplicationNumber.getShortDescriptionOfWork());
					requestBody.put("erp_no", findByConsumerApplicationNumber.getErpWorkFlowNumber());
					requestBody.put("consumerName", findByConsumerApplicationNumber.getConsumerName());
					requestBody.put("is_bid_submitted", "false");

					RestTemplate restTemplate = new RestTemplate();

//		         UAT Code
		        ResponseEntity<Map> postForEntity = restTemplate.postForEntity(ravindraSendDataAfterPayment, requestBody, Map.class);

//		        Production Code
//					ResponseEntity<Map> postForEntity = restTemplate
//							.postForEntity("https://qcportal.mpcz.in/tkc/get_consumer/", requestBody, Map.class);
					System.out.println("The result of Post api is :" + postForEntity.getBody());
				}
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
		return "data save";
	}

   @PostMapping("/Billdesk_payment_refundDemandAmount")
	public Response<Object> refundDemandAmount(
			@RequestBody BilldeskPaymentRetriveProcess billdeskPaymentRetriveProcess) {
		Response<Object> response = new Response<Object>();
		try {
			BillDeskPaymentResponse billDeskPaymentResponse = billPaymentResponseeeeeeeRepository
					.findByOrderidAndTranId(billdeskPaymentRetriveProcess.getOrderid(),
							billdeskPaymentRetriveProcess.getTransactionid());

			if (billDeskPaymentResponse == null) {
				response.setMessage("data not found please enter a vaild order id and transaction id");
				return response;
			}

//		create refund numner
			Random random = new Random();
			int digit = random.nextInt(900);
			int digit1 = random.nextInt(90000000);

			String refundId = "REF" + digit + "D" + digit1;

			System.out.println(refundId);
			JSONObject sendDataBillDesk = new JSONObject();

			sendDataBillDesk.put("transactionid", billDeskPaymentResponse.getTranId());
			sendDataBillDesk.put("orderid", billDeskPaymentResponse.getOrderid());

//		Uat code 	
			sendDataBillDesk.put("mercid", clientId);

//		prod code
//			sendDataBillDesk.put("mercid", "MPMKDSPV2");

			sendDataBillDesk.put("transaction_date", billDeskPaymentResponse.getTransactionDate());
			sendDataBillDesk.put("txn_amount", billDeskPaymentResponse.getAmount());
			sendDataBillDesk.put("refund_amount", billDeskPaymentResponse.getAmount());
			sendDataBillDesk.put("currency", "356");
			sendDataBillDesk.put("merc_refund_ref_no", refundId);

			JSONObject deviceMap = new JSONObject();
			deviceMap.put("accept_header", "text/html");
			deviceMap.put("init_channel", "internet");
			deviceMap.put("ip", "172.24.200.191");
			deviceMap.put("fingerprintid", "61b12c18b5d0cf901be34a23ca64bb19");

			sendDataBillDesk.put("device", deviceMap);

			HttpHeaders headers = new HttpHeaders();

			Long time = Timestamp.valueOf(LocalDateTime.now()).getTime();
			headers.set("Content-Type", "application/jose");
			headers.set("BD-timestamp", time.toString());
			headers.set("Accept", "application/jose");
			headers.set("BD-traceid", time.toString() + "123");

//		uat code 
			String convertObjectInString = encryptAndSignJWSWithHMAC(sendDataBillDesk.toString(),
					hashKey, clientKey);

//		producation code		
//			String convertObjectInString = encryptAndSignJWSWithHMAC(sendDataBillDesk.toString(),
//					"IJLmg3QiLBnDwb3IoeK13eXcYcvHVdP6", "mpmkdspv2");

			SimpleClientHttpRequestFactory clientHttpReq = new SimpleClientHttpRequestFactory();
			Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress("proxy.mpcz.in", 8080));
			clientHttpReq.setProxy(proxy);

			RestTemplate restTemplate = new RestTemplate(clientHttpReq);

//			uat code
			String url = refundCreate;

//			producation code
//			String url = "https://api.billdesk.com/payments/ve1_2/refunds/create";

			HttpEntity httpEntity = new HttpEntity<>(convertObjectInString, headers);
			System.err.println("httpEntity-->" + httpEntity);

			ResponseEntity<String> postForEntity = restTemplate.postForEntity(url, httpEntity, String.class);

			System.err.println("postForEntity-->" + postForEntity);
			String forObject = postForEntity.getBody();
			System.out.println("forObject-------------" + forObject);
			if (forObject == null && forObject.length() <= 0) {
				response.setMessage("response body is null");
				response.setCode("200");
				return response;
			}

///	       uat code
			String verifyAndDecryptJWSWithHMAC = verifyAndDecryptJWSWithHMAC(forObject,
					hashKey);

//			prod  hash key
//			String verifyAndDecryptJWSWithHMAC = verifyAndDecryptJWSWithHMAC(forObject,
//					"IJLmg3QiLBnDwb3IoeK13eXcYcvHVdP6");

			JSONObject jobObject = new JSONObject(verifyAndDecryptJWSWithHMAC);
			billDeskPaymentResponse.setRefundId(jobObject.getString("refundid"));
//			billDeskPaymentResponse.setAmount(jobObject.getString("refund_amount"));
			billDeskPaymentResponse.setTxnAmount(jobObject.getString("txn_amount"));
			billDeskPaymentResponse.setRefundDate(jobObject.getString("refund_date"));
			billDeskPaymentResponse.setMercRefundRefNo(jobObject.getString("transactionid"));
			billDeskPaymentResponse.setRefundStatus(jobObject.getString("refund_status"));
			billDeskPaymentResponse.setRefundAmount(jobObject.getString("refund_amount"));

			billPaymentResponseeeeeeeRepository.save(billDeskPaymentResponse);

			ConsumerApplicationDetail findByConsumerApplicationNumber = consumerApplictionDetailRepository
					.findByConsumerApplicationNumber(billDeskPaymentResponse.getConsumerApplicationNo());
			String consumerdetails = consumerApplicationStatusBack(findByConsumerApplicationNumber);
			if (consumerdetails.equals("data save")) {
				response.setMessage("Amount refund successfull");
				return response;
			} else {
				response.setMessage("Amount refund successfull but applicaiton status not Update");
				return response;
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
		response.setMessage("Amount allready refund ");
		return response;
	}

	public String consumerApplicationStatusBack(ConsumerApplicationDetail consumerApplicationDetail) {

		ApplicationStatus appStatusDb = consumerApplicationDetail.getApplicationStatus();
		try {

			if (consumerApplicationDetail.getApplicationStatus().getApplicationStatusId() == 20
					|| consumerApplicationDetail.getApplicationStatus().getApplicationStatusId() == 21
					|| consumerApplicationDetail.getApplicationStatus().getApplicationStatusId() == 23) {
				if (consumerApplicationDetail.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Deposit")) {
					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.DEMAND_PAYMENT_PENDING_BY_CONSUMER.getId());
				} else if (consumerApplicationDetail.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Supervision")
						&& consumerApplicationDetail.getNatureOfWorkType().getNatureOfWorkTypeId() != 5l) {
					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.DEMAND_PAYMENT_PENDING_BY_CONSUMER.getId());
				} else {
					appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.DEMAND_PAYMENT_PENDING_BY_CONSUMER.getId());
				}
				Date currentDate = new Date();

				// Create a calendar instance and set it to the current date
				Calendar calendar = Calendar.getInstance();
				calendar.setTime(currentDate);

				// Add three days to the current date
				calendar.add(Calendar.DAY_OF_MONTH, 3);

				// Get the new date
				Date newDate = calendar.getTime();

				// Create a formatter for the desired date format
				SimpleDateFormat formatter = new SimpleDateFormat("dd-MM-yyyy");

				// Format the dates using the formatter
				String currentDateFormatted = formatter.format(currentDate);
				String newDateFormatted = formatter.format(newDate);

				// Display the current date and the new date
				System.out.println("Current Date: " + currentDateFormatted);
				System.out.println("New Date: " + newDateFormatted);

				if (consumerApplicationDetail.getSchemeType().getSchemeTypeName().equalsIgnoreCase("Supervision")) {
					consumerApplicationDetail.setPaymentDate(newDateFormatted);
				}
			} else {
				appStatusDb = applicationStatusService
						.findById(ApplicationStatusEnum.PENDING_FOR_REGISTRATION_FEES.getId());
			}
			consumerApplicationDetail.setApplicationStatus(appStatusDb);
			consumerApplictionDetailRepository.save(consumerApplicationDetail);

			return "data save";
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}


	@GetMapping("/fees_genreted_recipt/{consumerApplicationNumber}/{slipGenretatedId}")
	public void genretedRecipt(@PathVariable String consumerApplicationNumber, @PathVariable long slipGenretatedId,
			HttpServletResponse response1) {

		try {
			List<BillDeskPaymentResponse> payres1 = billPaymentResponseeeeeeeRepository
					.findByConsumerApplicationNo(consumerApplicationNumber);

			for (BillDeskPaymentResponse payres : payres1) {
				double Amount = Double.parseDouble(payres.getAmount());

				if (payres != null && slipGenretatedId == 1l && Amount < 1200) {

					if (payres.getAuth_status().equals("0300")) {
						String redirectUrl = "/deposit_scheme/api/consumer/bill-desk/sendReciept" + "?accountId="
								+ payres.getConsumerApplicationNo() + "&custName=" + payres.getConsumerName()
								+ "&orderId=" + payres.getOrderid() + "&txnId=" + payres.getTranId() + "&txnAmount="
								+ payres.getAmount() + "&txnDate=" + payres.getTransactionDate() + "&status="
								+ "Success" + "&isFailed=" + Boolean.FALSE;

						response1.sendRedirect(redirectUrl);

					}
				}
				if (payres != null && slipGenretatedId == 2l && Amount > 1200) {
					if (payres.getAuth_status().equals("0300")) {
						String redirectUrl = "/deposit_scheme/api/consumer/bill-desk/sendReciept" + "?accountId="
								+ payres.getConsumerApplicationNo() + "&custName=" + payres.getConsumerName()
								+ "&orderId=" + payres.getOrderid() + "&txnId=" + payres.getTranId() + "&txnAmount="
								+ payres.getAmount() + "&txnDate=" + payres.getTransactionDate() + "&status="
								+ "Success" + "&isFailed=" + Boolean.FALSE;

						response1.sendRedirect(redirectUrl);
					}
				}
				
//				monika code start
				if (payres != null && slipGenretatedId == 3l && payres.getAdditionalInfo().equals("Revised_Demand_fees") ) {
					if (payres.getAuth_status().equals("0300")) {
						String redirectUrl = "/deposit_scheme/api/consumer/bill-desk/sendReciept" + "?accountId="
								+ payres.getConsumerApplicationNo() + "&custName=" + payres.getConsumerName()
								+ "&orderId=" + payres.getOrderid() + "&txnId=" + payres.getTranId() + "&txnAmount="
								+ payres.getAmount() + "&txnDate=" + payres.getTransactionDate() + "&status="
								+ "Success" + "&isFailed=" + Boolean.FALSE;

						response1.sendRedirect(redirectUrl);
					}
				}
//				end
				
			}

		} catch (Exception e) {
//			response1.sendRedirect("sendReciept?msg=" + paytmParams.get("RESPMSG") + "&isFailed=" + Boolean.TRUE
//					+ "&isFailedParam=" + Boolean.FALSE);
			e.printStackTrace();

		}

	}
	
	public void billdeskPaymentRetriveProcessByDate() {
		Response<Object> response = new Response<Object>();
		SimpleDateFormat formatter = new SimpleDateFormat("yyyy/MM/dd");
		Date date = new Date();
		String s = formatter.format(date);

		System.out.println(s + "okjikj");
//		 String[] split = s.split("/");
//		 int d =Integer.valueOf(split[2]);
//		 int d1=d-1;
//		 s=split[0]+"/"+ 10 +"/0"+8;

		List<BillDeskPaymentRequest1> billdesk = null;
		try {
			billdesk = billDeskPaymentRequestRepository.findbyPaymentUpdateDate(s);

			for (BillDeskPaymentRequest1 bill : billdesk) {
				try {

					BillDeskPaymentResponse billDeskPaymentResponse = billPaymentResponseeeeeeeRepository
							.findByOrderid(bill.getOrderId());

					if (billDeskPaymentResponse == null) {

						JSONObject createObjectForbillDesk = new JSONObject();

//			uat code 
						createObjectForbillDesk.put("mercid", clientId);
						createObjectForbillDesk.put("orderid", bill.getOrderId());
						String convertObjectInString = encryptAndSignJWSWithHMAC(createObjectForbillDesk.toString(),
								hashKey, clientKey);

//			producation code		
//						createObjectForbillDesk.put("mercid", "MPMKDSPV2");
//						createObjectForbillDesk.put("orderid", bill.getOrderId());
//						String convertObjectInString = encryptAndSignJWSWithHMAC(createObjectForbillDesk.toString(),
//								"IJLmg3QiLBnDwb3IoeK13eXcYcvHVdP6", "mpmkdspv2");

						SimpleClientHttpRequestFactory clientHttpReq = new SimpleClientHttpRequestFactory();
						Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress("proxy.mpcz.in", 8080));
						clientHttpReq.setProxy(proxy);

						RestTemplate restTemplate = new RestTemplate(clientHttpReq);

						HttpHeaders headers = new HttpHeaders();

						Long time = Timestamp.valueOf(LocalDateTime.now()).getTime();
						System.out.println("valueOf--->" + time.toString());
						headers.set("Content-Type", "application/jose");
						headers.set("BD-timestamp", time.toString());
						headers.set("Accept", "application/jose");
						headers.set("BD-traceid", time.toString() + "123");

//			uat url
						String url = transactionUrl;

//			production url
//						String url = "https://api.billdesk.com/payments/ve1_2/transactions/get";

						HttpEntity httpEntity = new HttpEntity<>(convertObjectInString, headers);
						System.err.println("httpEntity-->" + httpEntity);

						ResponseEntity<String> postForEntity = restTemplate.postForEntity(url, httpEntity,
								String.class);

						System.err.println("postForEntity-->" + postForEntity);
						String forObject = postForEntity.getBody();
						System.out.println("forObject-------------" + forObject);
						if (forObject == null && forObject.length() <= 0) {
							response.setMessage("response body is null");
							response.setCode("200");
							System.out.println("response body is null");
//					return response;
						}

//			uat  code
						String verifyAndDecryptJWSWithHMAC = verifyAndDecryptJWSWithHMAC(forObject,
								hashKey);

//			production code
//						String verifyAndDecryptJWSWithHMAC = verifyAndDecryptJWSWithHMAC(forObject,
//								"IJLmg3QiLBnDwb3IoeK13eXcYcvHVdP6");

						JSONObject jobObject = new JSONObject(verifyAndDecryptJWSWithHMAC);
						System.out.println(jobObject.getString("auth_status").equalsIgnoreCase("0300"));
						if (jobObject.getString("auth_status").equalsIgnoreCase("0300")) {
							String saveResponseBillDeskTable = saveResponseBillDeskTable(jobObject);
							if (saveResponseBillDeskTable.equals("data save")) {
								response.setMessage("data save payment Response class");
								System.out.println("data save payment Response class");
								System.out.println("data save payment Response class");
							}
						} else {
							response.setMessage("payment not successfull");
							System.out.println("payment not successfull");
//					return response;
						}
					} else {
						System.out.println("payment allready exits hai data base me");
					}
				} catch (Exception e) {
					e.printStackTrace();
					response.setMessage("is order id pr koi payment nai hua hai");
					System.out.println("is order id pr koi payment nai hua hai");
//				return response;
				}
			}
//		return response;
		} catch (Exception e) {
			e.printStackTrace();
		}
	}


	@GetMapping("/getPaymentDetailsByApplicationNo/{consumerApplicationNo}")
	public ResponseEntity<?> getPaymentDetailsByApplicationNo(
			@PathVariable("consumerApplicationNo") String consumerApplicationNo) {
		Response response = new Response();
		List<ManualPayment> manualPaymentdb = null;
		 PoseMachinePostData pose = null;
		Map<String, String> map = new LinkedHashMap<String, String>();

		List<BillDeskPaymentResponse> findByConsumerApplicationNo = billPaymentResponseeeeeeeRepository
				.findByConsumerApplicationNo(consumerApplicationNo);
		
		
		
		for (BillDeskPaymentResponse bill : findByConsumerApplicationNo) {
			if (bill.getAuth_status().equals("0300")) {
				map.put(bill.getAdditionalInfo(), bill.getAmount());
				map.put(bill.getAdditionalInfo() + "_Transaction_Id", bill.getTranId());
				map.put(bill.getAdditionalInfo() + "_Transaction_Date", bill.getTransactionDate());
			}
		}
//		 
		
		// Check if Demand_fees exists in the map
	    if (!map.containsKey("Demand_fees")) {
	        manualPaymentdb = manualPaymentRepository.findByConAppNo(consumerApplicationNo);
	        for (ManualPayment manualPayment : manualPaymentdb) {
	            if (manualPayment.getAuthStatus().equals("0300")) {
	                map.put(manualPayment.getPaymentType(), manualPayment.getAmount());
	                map.put(manualPayment.getPaymentType() + "_Transaction_Id", manualPayment.getBillRefNo());
	                map.put(manualPayment.getPaymentType() + "_Transaction_Date", manualPayment.getVerificationDate());
	            }
	        }

	        // Check if Demand_fees still not found and manualPaymentdb is empty
	        if (!map.containsKey("Demand_fees") && (manualPaymentdb == null || manualPaymentdb.isEmpty())) {
	            pose = poseMachinePostDataRepository.findByApplicationNumber(consumerApplicationNo);
	            if (pose != null) {
	                map.put("Demand_fees", pose.getTxnAmount().toString());
	                map.put("Demand_fees_Transaction_Id", pose.getMrNo());
	                map.put("Demand_fees_Transaction_Date", pose.getDateOfPayment().toString());
	            }
	        }
	    }

	    if (map.containsKey("Demand_fees")) {
	        response.setCode("200");
	        response.setMessage("Payment Received");
	        response.setList(Arrays.asList(map));
	        return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);
	    } else {
	        response.setCode("200");
	        response.setMessage("Payment Not Received");
	        return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);
	    }
	}

   public ResponseEntity<?> getAllOytPaymentDatePendingApplication() {
      Response response = new Response();
      List<ConsumerApplicationDetail> findAllOytApplication = this.consumerApplictionDetailRepository.findAllOytApplication();
      if (findAllOytApplication.isEmpty()) {
         response.setCode("Not Found");
         response.setMessage("No Oyt application found for filling payment date ");
         return ((BodyBuilder)ResponseEntity.ok().header("Content-Type, application/json", new String[0])).body(response);
      } else {
         Iterator var3 = findAllOytApplication.iterator();

         while(var3.hasNext()) {
            ConsumerApplicationDetail consumerApplicationDetail = (ConsumerApplicationDetail)var3.next();
            List<BillDeskPaymentResponse> findByConsumerApplicationNo = this.billPaymentResponseeeeeeeRepository.findByConsumerApplicationNo(consumerApplicationDetail.getConsumerApplicationNo());
            findByConsumerApplicationNo.stream().filter((a) -> {
               return a.getAuth_status().equalsIgnoreCase("0300") && a.getAdditionalInfo().equalsIgnoreCase("Demand_fees");
            }).forEach((b) -> {
               String transactionDate = b.getTransactionDate();
               System.out.println("Dateeeeeeeeee   " + transactionDate);
               LocalDateTime dateTime = LocalDateTime.parse(transactionDate, DateTimeFormatter.ISO_OFFSET_DATE_TIME);
               String formattedDate = dateTime.format(DateTimeFormatter.ofPattern("dd-MM-yyyy"));
               System.out.println("Formatted Date: " + formattedDate);
               LocalDateTime modifiedDateTime = dateTime.plusDays(3L);
               String modifiedFormattedDate = modifiedDateTime.format(DateTimeFormatter.ofPattern("dd-MM-yyyy"));
               consumerApplicationDetail.setPaymentDate(modifiedFormattedDate);
               ConsumerApplicationDetail save = (ConsumerApplicationDetail)this.consumerApplictionDetailRepository.save(consumerApplicationDetail);
            });
         }

         return null;
      }
   }

   public static BigDecimal roundAmountCgstAndSgst(BigDecimal amount) {
      BigDecimal roundedAmount = amount.setScale(0, RoundingMode.FLOOR);
      BigDecimal remainingPaise = amount.subtract(roundedAmount);
      if (remainingPaise.compareTo(new BigDecimal(0.5D)) >= 0) {
         roundedAmount = roundedAmount.add(BigDecimal.ONE);
      }

      return roundedAmount;
   }
}