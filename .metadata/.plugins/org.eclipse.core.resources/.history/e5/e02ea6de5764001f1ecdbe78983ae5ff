package com.mpcz.deposit_scheme.backend.api.services.impl;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Optional;

import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.google.gson.JsonObject;
import com.mpcz.deposit_scheme.backend.api.constant.HttpCode;
import com.mpcz.deposit_scheme.backend.api.constant.ResponseMessage;
import com.mpcz.deposit_scheme.backend.api.controller.ErpRevController;
import com.mpcz.deposit_scheme.backend.api.domain.ApplicationStatus;
import com.mpcz.deposit_scheme.backend.api.domain.ConsumerApplicationDetail;
import com.mpcz.deposit_scheme.backend.api.domain.ErpEstimateAmountData;
import com.mpcz.deposit_scheme.backend.api.domain.ErpEstimateDomain;
import com.mpcz.deposit_scheme.backend.api.domain.ErpRev;
import com.mpcz.deposit_scheme.backend.api.domain.MmkyPayAmount;
import com.mpcz.deposit_scheme.backend.api.enums.ApplicationStatusEnum;
import com.mpcz.deposit_scheme.backend.api.repository.ConsumerApplictionDetailRepository;
import com.mpcz.deposit_scheme.backend.api.repository.ErpRevRepository;
import com.mpcz.deposit_scheme.backend.api.repository.EstimateAmountRepository;
import com.mpcz.deposit_scheme.backend.api.repository.EstimateRepository;
import com.mpcz.deposit_scheme.backend.api.repository.MmkyPayAmountRespository;
import com.mpcz.deposit_scheme.backend.api.response.Response;
import com.mpcz.deposit_scheme.backend.api.services.ApplicationStatusService;
import com.mpcz.deposit_scheme.backend.api.services.ConsumerApplicationDetailService;
import com.mpcz.deposit_scheme.backend.api.services.ErpRevService;

@Service
public class ErpRevServiceIMP implements ErpRevService {

	@Autowired
	private ConsumerApplicationDetailService ConsumerApplicationDetailService;

	@Autowired
	private ErpRevRepository erpRevRepository;

	@Autowired
	private EstimateAmountRepository estimateAmountRepository;

	@Autowired
	private ApplicationStatusService applicationStatusService;

	@Autowired
	private MmkyPayAmountRespository mmkyPayAmountRespository;

	@Override
	public ErpRev save(String erpNo, String applicationNo, Long value) {

		ResponseEntity<String> exchange = null;
		ErpEstimateAmountData erpEstimateAmountData = null;
		BigDecimal jeReturnAmount = new BigDecimal(0.0);
		BigDecimal colonyOrSlum = new BigDecimal(0.0);
		RestTemplate rest = new RestTemplate();
		ErpRev erpRev = new ErpRev();
		JSONObject json = null;
		BigDecimal oldSupervisionAmount = new BigDecimal(0.0);

		Long l = null;
		Long individualOrGroupId = 10L;
		BigDecimal oldCgst = new BigDecimal(0.0);
		BigDecimal oldSgst = new BigDecimal(0.0);
		BigDecimal newColonyOrSlum = new BigDecimal(0.0);
		BigDecimal newCgst = new BigDecimal(0.0);
		BigDecimal newSgst = new BigDecimal(0.0);
		BigDecimal newKvaLoad = new BigDecimal(0.0);
		BigDecimal newSuperVisionAmt = new BigDecimal(0.0);
		BigDecimal newEstimateAmount = new BigDecimal(0.0);
		BigDecimal remReturnAmt = new BigDecimal(0.0);
		BigDecimal oAndMReturnAmount = new BigDecimal(0.0);
		BigDecimal minusCost = new BigDecimal(0.0);

		try {
			ConsumerApplicationDetail findConsumerApplicationDetailByApplicationNo = ConsumerApplicationDetailService
					.findConsumerApplicationDetailByApplicationNo(applicationNo);

			String url = "https://dsp.mpcz.in:8888/urjas/XXPA_PROJECTS_DSP_V/" + erpNo;
			HttpEntity<ErpRev> httpEntity = new HttpEntity<>(null);

			exchange = rest.exchange(url, HttpMethod.GET, httpEntity, String.class);
			json = new JSONObject(exchange.getBody());
			if (json.get("statusCode").toString().equals("404")) {
				String url1 = "https://dsp.mpcz.in:8888/newerp/XXPA_PROJECTS_DSP_V/" + erpNo;
				exchange = rest.exchange(url1, HttpMethod.GET, httpEntity, String.class);
				json = new JSONObject(exchange.getBody());
			}
			if (json.get("statusCode").toString().equals("200")) {
				JSONArray jsonArray = json.getJSONArray("data");
				for (int i = 0; i < jsonArray.length(); i++) {
					if (jsonArray.getJSONObject(i).getString("SCHEMECODE") != null
							&& jsonArray.getJSONObject(i).getString("PROJECT_TYPE") != null) {

						if ((jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("SCCW")
								&& !findConsumerApplicationDetailByApplicationNo.getSchemeType().getSchemeTypeId()
										.equals(1L))

								|| (jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("DEPOSITE")
										&& !findConsumerApplicationDetailByApplicationNo.getSchemeType()
												.getSchemeTypeId().equals(2L))
								|| (jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("KMY")
										&& !findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
												.getNatureOfWorkName().equals("MKMY"))
								|| (jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("OYT")
										&& !findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
												.getNatureOfWorkTypeId().equals(5L))
								|| (jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("RRTD")
										&& (findConsumerApplicationDetailByApplicationNo.getSchemeType()
												.getSchemeTypeId().equals(1L)
												|| findConsumerApplicationDetailByApplicationNo.getSchemeType()
														.getSchemeTypeId().equals(2L)))

								|| (jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("DEPOSITE")
										&& findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
												.getNatureOfWorkTypeId() == 8l)
								|| (jsonArray.getJSONObject(i).getString("SCHEMECODE").equals("SCCW")
										&& findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
												.getNatureOfWorkTypeId() == 5l)) {

							erpRev.setSchemeCode("Scheme code not match");
							return erpRev;
						}

					}
				}
			}

			System.out.println(json);
			if (json.get("statusCode").toString().equals("200")) {
				JSONArray jsonArray = json.getJSONArray("data");
				for (int i = 0; i < jsonArray.length(); i++) {

					if (jsonArray.getJSONObject(i).getString("PROJECT_NUMBER") != null)
						erpRev.setNewErpNo(jsonArray.getJSONObject(i).getString("PROJECT_NUMBER"));
					if (jsonArray.getJSONObject(i).getString("ORGANIZATION_NAME") != null)
						erpRev.setLocation(jsonArray.getJSONObject(i).getString("ORGANIZATION_NAME"));
					if (jsonArray.getJSONObject(i).getString("STATUS") != null)
						erpRev.setEstimateStatus(jsonArray.getJSONObject(i).getString("STATUS"));
					if (jsonArray.getJSONObject(i).getString("SUPERVISION_COST") != null) {

						newSuperVisionAmt = roundAmountCgstAndSgst(new BigDecimal(jsonArray.getJSONObject(i).getString("SUPERVISION_COST")));
						
						newCgst = roundAmountCgstAndSgst(newSuperVisionAmt.multiply(new BigDecimal(.09)));
						newSgst = roundAmountCgstAndSgst(newSuperVisionAmt.multiply(new BigDecimal(.09)));

						erpRev.setNewSupervisionAmt(newSuperVisionAmt);
						erpRev.setNewCgst(newCgst);
						erpRev.setNewSgst(newSgst);

					}
					if (jsonArray.getJSONObject(i).getString("ESTIMATED_COST") != null) {
						newEstimateAmount =roundAmountCgstAndSgst(new BigDecimal(jsonArray.getJSONObject(i).getString("ESTIMATED_COST")));

						erpRev.setNewEstimateAmt(newEstimateAmount);
					}

					if (jsonArray.getJSONObject(i).getString("APPROVED_BY_NAME") != null)
						erpRev.setApprovedBy(jsonArray.getJSONObject(i).getString("APPROVED_BY_NAME"));

					if (jsonArray.getJSONObject(i).getString("ESTIMATE_NO") != null)
						erpRev.setEstimatsenctionNo(jsonArray.getJSONObject(i).getString("ESTIMATE_NO"));

					if (jsonArray.getJSONObject(i).getString("LONG_NAME") != null)
						erpRev.setEstimateName(jsonArray.getJSONObject(i).getString("LONG_NAME"));

					if (jsonArray.getJSONObject(i).getString("ESTIMATE_DATE") != null)
						erpRev.setEstimateDate(jsonArray.getJSONObject(i).getString("ESTIMATE_DATE"));

					if (jsonArray.getJSONObject(i).getString("DESIG") != null)
						erpRev.setDesignation(jsonArray.getJSONObject(i).getString("DESIG"));

					if (jsonArray.getJSONObject(i).getString("SCHEMECODE") != null
							&& jsonArray.getJSONObject(i).getString("PROJECT_TYPE") != null) {

						erpRev.setSchemeCode(jsonArray.getJSONObject(i).getString("SCHEMECODE"));

					}
					erpRev.setConsAppNo(applicationNo);

					Optional<ErpEstimateAmountData> erpEstimateAmountData1 = estimateAmountRepository
							.findById(findConsumerApplicationDetailByApplicationNo.getErpWorkFlowNumber());

					if (erpEstimateAmountData1.isPresent()) {
						erpEstimateAmountData = erpEstimateAmountData1.get();

						oldSupervisionAmount = erpEstimateAmountData.getSupervisionAmount();

						if (erpEstimateAmountData.getJeReturnAmount() != null) {
							jeReturnAmount = erpEstimateAmountData.getJeReturnAmount();
						}
						if (erpEstimateAmountData.getColonyOrSlum() != null) {
							colonyOrSlum = erpEstimateAmountData.getColonyOrSlum();
						}
						if(erpEstimateAmountData.getKvaLoad()!=null) {
						erpRev.setOldkvaloadAmt(erpEstimateAmountData.getKvaLoad());
						}
						
						erpRev.setOldkWloadAmt(erpEstimateAmountData.getKwLoad());

						erpRev.setOldSupervision(oldSupervisionAmount);

						if (erpEstimateAmountData.getCgst() != null) {
							oldCgst = erpEstimateAmountData.getCgst();
							oldSgst = erpEstimateAmountData.getSgst();

							erpRev.setOldCgst(oldCgst);
							erpRev.setOldSgst(oldSgst);

							erpRev.setRemCgst(roundAmountCgstAndSgst(newCgst.subtract(oldCgst)));
							erpRev.setRemSgst(roundAmountCgstAndSgst(newSgst.subtract(oldSgst)));

						}
					}
					// These line added for adding remaining return amount
					if (findConsumerApplicationDetailByApplicationNo.getoAndMReturnAmount() != null) {
						oAndMReturnAmount = roundAmountCgstAndSgst(findConsumerApplicationDetailByApplicationNo.getoAndMReturnAmount());
						remReturnAmt = roundAmountCgstAndSgst(oAndMReturnAmount.subtract(jeReturnAmount));
						erpRev.setoAndMReturnAmt(oAndMReturnAmount);
						erpRev.setRemReturnAmt(remReturnAmt);
					}
					// These line added for adding remaining return amount

					if (findConsumerApplicationDetailByApplicationNo.getSchemeType().getSchemeTypeId() == 2) {

						if (findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
								.getNatureOfWorkTypeId() == 8l) {
							MmkyPayAmount oldMmkyPayAmountDb = mmkyPayAmountRespository
									.findByConsumerApplicationNumber(applicationNo);

							BigDecimal oldGovMaffAmt = round11(oldMmkyPayAmountDb.getGovMafBill(), 2);
							BigDecimal oldMpmkvvclMaffAmt = round11(oldMmkyPayAmountDb.getMpmkMafBill(), 2);
							BigDecimal oldMkmyPayableAmt = round11(oldMmkyPayAmountDb.getPayableAmount(), 2);
							BigDecimal oldTotalAmountMkmy = round11(oldMmkyPayAmountDb.getTotalAmount(), 2);
							BigDecimal carryAmountByApplicant = round11(oldMmkyPayAmountDb.getCarryAmountByApplicant(),
									2);

							BigDecimal oldAvedanShulk = oldMmkyPayAmountDb.getAvedanShulk();
							BigDecimal oldSecurityDeposit = oldMmkyPayAmountDb.getSecurityDeposit();

							erpRev.setOldGovMafAmt(oldGovMaffAmt);
							erpRev.setOldMpmkMafAmt(oldMpmkvvclMaffAmt);
							erpRev.setOldMkmyPayAmt(oldMkmyPayableAmt);
							erpRev.setOldEstimate(oldTotalAmountMkmy);
							erpRev.setOldAvedanShulk(oldAvedanShulk);
							erpRev.setOldMkmySecurityDeposit(oldSecurityDeposit);
							erpRev.setOldCarryAmt(carryAmountByApplicant);

							BigDecimal newGovMaffAmt = round11(newEstimateAmount.multiply(new BigDecimal(.40)), 2);
							BigDecimal newMpmkvvclMaffAmt = round11(newEstimateAmount.multiply(new BigDecimal(.10)), 2);
							BigDecimal mpmkPayAmt = round11(
									newEstimateAmount.subtract(newGovMaffAmt).subtract(newMpmkvvclMaffAmt), 2);

							erpRev.setGovMafAmt(newGovMaffAmt);
							erpRev.setMpmkMafAmt(newMpmkvvclMaffAmt);
							erpRev.setMkmyPayAmt(mpmkPayAmt);

							erpRev.setRemGovMafAmt(newGovMaffAmt.subtract(oldGovMaffAmt));
							erpRev.setRemMpmkMafAmt(newMpmkvvclMaffAmt.subtract(oldMpmkvvclMaffAmt));
							erpRev.setRemMkmyPayAmt(
									mpmkPayAmt.subtract(oldTotalAmountMkmy.multiply(new BigDecimal(.50))));
							erpRev.setPayAmt(mpmkPayAmt.subtract(oldTotalAmountMkmy.multiply(new BigDecimal(.50))));

							erpRev.setRemEstimateAmt(newEstimateAmount.subtract(oldMmkyPayAmountDb.getTotalAmount()));
						} else {
							BigDecimal oldEstimateAmount = new BigDecimal(erpEstimateAmountData.getEstimateAmount());
							BigDecimal oldDepositAmountDb = erpEstimateAmountData.getDepositAmount();
							BigDecimal oldSupervisionAmountDb = erpEstimateAmountData.getSupervisionAmount();
							BigDecimal oldTotalBalanceDepositAmount = erpEstimateAmountData
									.getTotalBalanceDepositAmount();
								
//								erpRev.setOldPayableAmt(oldEstimateAmount);

							erpRev.setOldDeposit(oldDepositAmountDb);
							erpRev.setOldSupervision(oldSupervisionAmountDb);
							erpRev.setOldEstimate(oldEstimateAmount);
							erpRev.setOldJeReturnAmt(jeReturnAmount);
							erpRev.setOldColonyOrSlum(colonyOrSlum);
							erpRev.setOldPayableAmt(oldTotalBalanceDepositAmount);

//							minus cost code added on 27- august -2024 by monika rajpoot
							 minusCost = roundAmountCgstAndSgst(new BigDecimal(jsonArray.getJSONObject(i).getString("MINUS_COST")));
							
//							 BigDecimal newDepositAmt = newEstimateAmount.subtract(newSuperVisionAmt).subtract(newCgst)
//										.subtract(newSgst);
							
							BigDecimal newDepositAmount = newEstimateAmount.subtract(newSuperVisionAmt).subtract(newCgst)
									.subtract(newSgst);
							
							BigDecimal newDepositAmt = newDepositAmount.subtract(minusCost);
							
							BigDecimal newEstimateAmnt = newDepositAmt.add(newSuperVisionAmt).add(newCgst).add(newSgst);

							erpRev.setNewMinusCost(minusCost);
//							minus cost code added on 27- august -2024 by monika rajpoot
							erpRev.setNewDepositAmt(newDepositAmt);
							erpRev.setRemmDepositAmt(roundAmountCgstAndSgst(newDepositAmt.subtract(oldDepositAmountDb)));
							erpRev.setRemSupervisionAmt(roundAmountCgstAndSgst(newSuperVisionAmt.subtract(oldSupervisionAmountDb)));
//							erpRev.setRemEstimateAmt(newEstimateAmount.subtract(oldEstimateAmount));
//							erpRev.setNewPayAmt(newEstimateAmount.add(oAndMReturnAmount));
//							erpRev.setPayAmt(roundAmountCgstAndSgst(newEstimateAmount.add(oAndMReturnAmount).subtract(oldTotalBalanceDepositAmount)));
							
							erpRev.setRemEstimateAmt(newEstimateAmnt.subtract(oldEstimateAmount));
							erpRev.setNewPayAmt(newEstimateAmnt.add(oAndMReturnAmount));
							erpRev.setPayAmt(roundAmountCgstAndSgst(newEstimateAmnt.add(oAndMReturnAmount).subtract(oldTotalBalanceDepositAmount)));
							
							
							
							// Deposit Nature of work 3 Legal case
							if (findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
									.getNatureOfWorkTypeId().equals(3L)) {
								BigDecimal oAndMLoad = findConsumerApplicationDetailByApplicationNo.getoAndMLoad();
								// jab getoAndMLoad 1500 ya usse kam ho
								if (findConsumerApplicationDetailByApplicationNo.getoAndMLoad()
										.compareTo(new BigDecimal(1500)) <= 0) {

									newKvaLoad = roundAmountCgstAndSgst(oAndMLoad.multiply(new BigDecimal(850)));
									erpRev.setNewKvaAmt(newKvaLoad);

									BigDecimal remKvaLoad = roundAmountCgstAndSgst(newKvaLoad.subtract(erpEstimateAmountData.getKvaLoad()));
									erpRev.setRemKvaAmt(remKvaLoad);
									// These line added for adding remaining return amount
//									BigDecimal newTotalEstimate = newEstimateAmount.add(remKvaLoad).add(remReturnAmt);
									BigDecimal newTotalEstimate = newEstimateAmnt.add(remKvaLoad).add(remReturnAmt);
									erpRev.setPayAmt(roundAmountCgstAndSgst(newTotalEstimate.subtract(oldTotalBalanceDepositAmount)));
								} else {

//									erpRev.setPayAmt(
//											roundAmountCgstAndSgst(newEstimateAmount.add(remReturnAmt).subtract(oldTotalBalanceDepositAmount)));
									erpRev.setPayAmt(
											roundAmountCgstAndSgst(newEstimateAmnt.add(remReturnAmt).subtract(oldTotalBalanceDepositAmount)));
									
								}

								if (newKvaLoad.compareTo(BigDecimal.ZERO) == 0) {
//									erpRev.setNewPayAmt(newEstimateAmount);
									erpRev.setNewPayAmt(newEstimateAmnt);
								} else {
//									erpRev.setNewPayAmt(newEstimateAmount.add(newKvaLoad));
									erpRev.setNewPayAmt(newEstimateAmnt.add(newKvaLoad));
								}
								erpRev.setRemSupervisionAmt(roundAmountCgstAndSgst(newSuperVisionAmt.subtract(oldSupervisionAmountDb)));
							}

							// Deposit Nature of work 4 Illegal case
							else if (findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
									.getNatureOfWorkTypeId().equals(4L)) {

								if (findConsumerApplicationDetailByApplicationNo.getColonyIllegalSelectionType()
										.equals("1")
										|| findConsumerApplicationDetailByApplicationNo.getIndividualOrGroup()
												.getIndividualOrGroupId() == null
										|| findConsumerApplicationDetailByApplicationNo.getIndividualOrGroup()
												.getIndividualOrGroupId() == 2L) {

//									erpRev.setPayAmt(
//											roundAmountCgstAndSgst(newEstimateAmount.add(remReturnAmt).subtract(oldTotalBalanceDepositAmount)));
									
									erpRev.setPayAmt(
											roundAmountCgstAndSgst(newEstimateAmnt.add(remReturnAmt).subtract(oldTotalBalanceDepositAmount)));
								} else if (findConsumerApplicationDetailByApplicationNo.getIndividualOrGroup()
										.getIndividualOrGroupId() == 1L) {
									BigDecimal oAndMLoad = findConsumerApplicationDetailByApplicationNo.getoAndMLoad();
									if ( findConsumerApplicationDetailByApplicationNo
											.getoAndMLoad().compareTo(new BigDecimal(400)) <= 0) {
										newColonyOrSlum = roundAmountCgstAndSgst(oAndMLoad.multiply(new BigDecimal(15567)));
										erpRev.setNewColonyOrSlum(newColonyOrSlum);
										BigDecimal remColonyOrSlum =roundAmountCgstAndSgst( newColonyOrSlum.subtract(colonyOrSlum));
										erpRev.setRemColonyOrSlum(remColonyOrSlum);

										erpRev.setNewSupervisionAmt(null);
										erpRev.setNewCgst(null);
										erpRev.setNewSgst(null);
										erpRev.setNewDepositAmt(null);
										erpRev.setNewEstimateAmt(null);
										erpRev.setRemSupervisionAmt(null);
										erpRev.setRemCgst(null);
										erpRev.setRemSgst(null);
										erpRev.setRemEstimateAmt(null);
										erpRev.setRemmDepositAmt(null);
										erpRev.setOldSupervision(null);
										
										
										if (colonyOrSlum.compareTo(BigDecimal.ZERO) != 0) {
											erpRev.setNewPayAmt(remColonyOrSlum);
											erpRev.setRemColonyOrSlum(remColonyOrSlum);
											erpRev.setNewPayAmt(newColonyOrSlum);
											erpRev.setPayAmt(remColonyOrSlum);
										} else {
											erpRev.setNewPayAmt(remColonyOrSlum);
											erpRev.setPayAmt(roundAmountCgstAndSgst(remColonyOrSlum.subtract(oldTotalBalanceDepositAmount)));
										}
									} else {
										erpRev.setNewPayAmt(newEstimateAmount.add(remReturnAmt));
										erpRev.setPayAmt(roundAmountCgstAndSgst(newEstimateAmount.add(remReturnAmt)
												.subtract(oldTotalBalanceDepositAmount)));
									}
								} 
								else {
									erpRev.setNewPayAmt(
											newEstimateAmount.add(remReturnAmt));
									erpRev.setPayAmt(
											roundAmountCgstAndSgst(newEstimateAmount.add(remReturnAmt).subtract(oldTotalBalanceDepositAmount)));
								}
							}

						}

					} else {
						BigDecimal oldtotalBalanceSupervisionAmount = erpEstimateAmountData
								.getTotalBalanceSupervisionAmount();

						BigDecimal newSuperVisionAmt1 =roundAmountCgstAndSgst( newSuperVisionAmt.add(erpRev.getNewCgst())
								.add(erpRev.getNewSgst()).add(oAndMReturnAmount)
								.subtract(oldtotalBalanceSupervisionAmount));

						erpRev.setRemSupervisionAmt(roundAmountCgstAndSgst(newSuperVisionAmt.subtract(oldSupervisionAmount)));
						erpRev.setOldJeReturnAmt(jeReturnAmount);
						erpRev.setOldColonyOrSlum(colonyOrSlum);
						erpRev.setOldPayableAmt(oldtotalBalanceSupervisionAmount);
						erpRev.setNewPayAmt(newSuperVisionAmt.add(erpRev.getNewCgst()).add(erpRev.getNewSgst())
								.add(oAndMReturnAmount));
						erpRev.setPayAmt(newSuperVisionAmt1);

						// Supervision Nature of work 3 Legal case
						if (findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType().getNatureOfWorkTypeId()
								.equals(3L)) {
							BigDecimal oAndMLoad = findConsumerApplicationDetailByApplicationNo.getoAndMLoad();
							if (findConsumerApplicationDetailByApplicationNo.getoAndMLoad()
									.compareTo(new BigDecimal(1500)) <= 0) {

								newKvaLoad = roundAmountCgstAndSgst(oAndMLoad.multiply(new BigDecimal(850)));
								erpRev.setNewKvaAmt(newKvaLoad);

								BigDecimal remKvaLoad = roundAmountCgstAndSgst(newKvaLoad.subtract(erpEstimateAmountData.getKvaLoad()));
								erpRev.setRemKvaAmt(remKvaLoad);
								// Monika code start
								BigDecimal newSuperVisionAmt2 = roundAmountCgstAndSgst(newSuperVisionAmt.add(erpRev.getNewCgst())
										.add(erpRev.getNewSgst())
										.subtract(oldSupervisionAmount.add(oldCgst).add(oldSgst)));
								// End
								erpRev.setPayAmt(newSuperVisionAmt2.add(remKvaLoad).add(remReturnAmt));
								
							} else {
								erpRev.setPayAmt(newSuperVisionAmt1.add(remReturnAmt));
							}
							
							if (newKvaLoad.compareTo(BigDecimal.ZERO) == 0) {
								erpRev.setNewPayAmt(newSuperVisionAmt.add(erpRev.getNewCgst()).add(erpRev.getNewSgst())
										.add(oAndMReturnAmount));
							} else {
								erpRev.setNewPayAmt(newSuperVisionAmt.add(erpRev.getNewCgst()).add(erpRev.getNewSgst())
										.add(newKvaLoad).add(oAndMReturnAmount));
							}
						}

						// Supervision Nature of work 4 Illegal case
						else if (findConsumerApplicationDetailByApplicationNo.getNatureOfWorkType()
								.getNatureOfWorkTypeId().equals(4L)) {
							if (findConsumerApplicationDetailByApplicationNo.getColonyIllegalSelectionType().equals("1")
									|| findConsumerApplicationDetailByApplicationNo.getIndividualOrGroup()
											.getIndividualOrGroupId() == null
									|| findConsumerApplicationDetailByApplicationNo.getIndividualOrGroup()
											.getIndividualOrGroupId() == 2L) {

								erpRev.setPayAmt(newSuperVisionAmt1);
							} else if (findConsumerApplicationDetailByApplicationNo.getIndividualOrGroup()
									.getIndividualOrGroupId()==1L) {
								
								BigDecimal oAndMLoad = findConsumerApplicationDetailByApplicationNo.getoAndMLoad();
								if (findConsumerApplicationDetailByApplicationNo
										.getoAndMLoad().compareTo(new BigDecimal(400)) <= 0) {

									newColonyOrSlum = roundAmountCgstAndSgst(oAndMLoad.multiply(new BigDecimal(15567)));
									erpRev.setNewColonyOrSlum(newColonyOrSlum);
									BigDecimal remColonyOrSlum = roundAmountCgstAndSgst(newColonyOrSlum.subtract(colonyOrSlum));
									erpRev.setRemColonyOrSlum(remColonyOrSlum);
									erpRev.setNewSupervisionAmt(null);
									erpRev.setNewCgst(null);
									erpRev.setNewSgst(null);
									erpRev.setNewDepositAmt(null);
									erpRev.setNewEstimateAmt(null);
									erpRev.setRemSupervisionAmt(null);
									erpRev.setRemCgst(null);
									erpRev.setRemSgst(null);
									erpRev.setRemEstimateAmt(null);
									erpRev.setRemmDepositAmt(null);
									erpRev.setOldSupervision(null);
									
									
									if (colonyOrSlum.compareTo(BigDecimal.ZERO) != 0) {
										erpRev.setNewSupervisionAmt(null);
										erpRev.setNewCgst(null);
										erpRev.setNewSgst(null);
										erpRev.setRemColonyOrSlum(remColonyOrSlum);
										erpRev.setNewPayAmt(newColonyOrSlum);
										erpRev.setPayAmt(remColonyOrSlum);
									} else {
										erpRev.setNewPayAmt(remColonyOrSlum);
										erpRev.setPayAmt(remColonyOrSlum.subtract(oldtotalBalanceSupervisionAmount));
									}
								} else {
									erpRev.setNewPayAmt(newSuperVisionAmt1.add(remReturnAmt));
									erpRev.setPayAmt(newSuperVisionAmt1.add(remReturnAmt));
								}
							}

						}
					
//					    erpRev.setNewPayAmt(newSuperVisionAmt.add(erpRev.getNewCgst()).add(erpRev.getNewSgst())
//						.add(oAndMReturnAmount));
//						erpRev.setNewPayAmt(newSuperVisionAmt.add(erpRev.getNewCgst()).add(erpRev.getNewSgst())
//									.add(newKvaLoad).add(oAndMReturnAmount));
						
					}

				}
			}

			if (value == 2L) {
				ErpRev save = erpRevRepository.save(erpRev);

				if (save != null) {
					ApplicationStatus appStatusDb = applicationStatusService
							.findById(ApplicationStatusEnum.REMAING_DEMAND_PAYMENT_PENDING_BY_CONSUMER.getId());

					findConsumerApplicationDetailByApplicationNo.setApplicationStatus(appStatusDb);
					findConsumerApplicationDetailByApplicationNo.setErpVersion("V2");
					findConsumerApplicationDetailByApplicationNo.setRevisedErpNumber(erpNo);
					ConsumerApplicationDetail saveConsumerApplication = ConsumerApplicationDetailService
							.saveConsumerApplication(findConsumerApplicationDetailByApplicationNo);
					findConsumerApplicationDetailByApplicationNo.setApplicationStatus(appStatusDb);

					return save;

				}
			} else {
				return erpRev;
			}

		} catch (Exception e) {
			e.printStackTrace();
		}

		return null;
	}

	public static BigDecimal round11(BigDecimal value, int places) {
		if (places < 0)
			throw new IllegalArgumentException();
		BigDecimal bd = value;
		bd = bd.setScale(2, RoundingMode.CEILING);
		return bd;
	}

	@Override
	public ResponseEntity<?> getConsumerApplication(String consumerApp) {
		Response response = new Response();
		ErpRev findByConsAppNo = erpRevRepository.findByConsAppNo(consumerApp);

		if (findByConsAppNo == null) {
			response.setCode(HttpCode.NULL_OBJECT);
			response.setMessage("Application no. not found in Revised ERP Table");
			return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);
		}
		response.setCode(HttpCode.OK);
		response.setMessage("Data Retrieved Successfully !!!!!!");
		response.setList(Arrays.asList(findByConsAppNo));
		return ResponseEntity.ok().header(ResponseMessage.APPLICATION_TYPE_JSON).body(response);
	}
	
	public static BigDecimal round111(BigDecimal value, int places) {
		if (places < 0)
			throw new IllegalArgumentException();
		BigDecimal bd = value;
		bd = bd.setScale(places, RoundingMode.CEILING);
		return bd;
	}
	

	
	
	 public static BigDecimal roundAmountCgstAndSgst(BigDecimal amount) {
		    BigDecimal roundedAmount = amount.setScale(0, RoundingMode.FLOOR); // Get the integer part

		    BigDecimal remainingPaise = amount.subtract(roundedAmount); // Get the decimal part (paise)

		    if (remainingPaise.compareTo(new BigDecimal(0.5)) >= 0) {
		      roundedAmount = roundedAmount.add(BigDecimal.ONE); // Round up if paise is 50 or more
		    }
		    return roundedAmount;
		  }
	
}
